<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack ‚Äî Royal Table</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-light: #e8d08a;
    --gold-dark: #8b6914;
    --green: #0a3d2e;
    --green-felt: #0d4d38;
    --green-light: #1a6b52;
    --dark: #0a0a0a;
    --darker: #050505;
    --card-bg: #faf8f0;
    --text: #e8e0d0;
    --red: #c0392b;
    --black: #1a1a1a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cormorant Garamond', serif;
    background: var(--darker);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* TOP BAR */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid rgba(201,168,76,0.1);
    position: sticky;
    top: 0;
    z-index: 500;
    backdrop-filter: blur(8px);
    gap: 10px;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: rgba(201,168,76,0.6);
    text-decoration: none;
    font-size: 0.75rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    transition: color 0.2s;
    font-family: 'Cormorant Garamond', serif;
    -webkit-tap-highlight-color: transparent;
    white-space: nowrap;
  }
  .back-link:hover { color: var(--gold); }
  .back-link svg { transition: transform 0.2s; flex-shrink: 0; }
  .back-link:hover svg { transform: translateX(-3px); }

  .top-bar-title {
    font-size: 0.65rem;
    letter-spacing: 5px;
    text-transform: uppercase;
    color: rgba(201,168,76,0.3);
    white-space: nowrap;
  }

  .top-bar-balance {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(201,168,76,0.07);
    border: 1px solid rgba(201,168,76,0.2);
    padding: 5px 12px;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .top-bar-balance:hover { background: rgba(201,168,76,0.13); border-color: rgba(201,168,76,0.4); }
  .top-bar-balance .tbl-label { font-size: 0.6rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(201,168,76,0.45); }
  .top-bar-balance .tbl-amount { font-family: 'Playfair Display', serif; font-size: 0.95rem; color: var(--gold); }

  @media (max-width: 520px) {
    .top-bar { padding: 8px 12px; }
    .top-bar-title { display: none; }
    .back-link { font-size: 0.7rem; letter-spacing: 2px; }
    .top-bar-balance .tbl-label { display: none; }
    .top-bar-balance { padding: 5px 8px; }
    .top-bar-balance .tbl-amount { font-size: 0.85rem; }
  }
  @media (max-width: 360px) { .back-link span { display: none; } }

  /* BALANCE MODAL */
  .balance-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 2000;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 64px 16px 0 0;
    backdrop-filter: blur(4px);
  }
  .balance-modal-overlay.open { display: flex; }

  .balance-modal {
    background: #0d0d0d;
    border: 1px solid rgba(201,168,76,0.3);
    width: 340px;
    max-width: calc(100vw - 24px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    animation: slideDown 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .balance-modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }

  .bm-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px 14px; border-bottom: 1px solid rgba(201,168,76,0.12); }
  .bm-title { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.1rem; letter-spacing: 3px; }
  .bm-close { background: none; border: none; color: rgba(201,168,76,0.5); font-size: 1.3rem; cursor: pointer; line-height: 1; padding: 4px; transition: color 0.2s; }
  .bm-close:hover { color: var(--gold); }

  .bm-amount { text-align: center; padding: 24px 20px 18px; border-bottom: 1px solid rgba(201,168,76,0.1); }
  .bm-amount-label { font-size: 0.62rem; letter-spacing: 5px; text-transform: uppercase; color: rgba(201,168,76,0.4); margin-bottom: 8px; }
  .bm-amount-value { font-family: 'Playfair Display', serif; font-size: 2.4rem; color: var(--gold); text-shadow: 0 0 30px rgba(201,168,76,0.25); }

  .bm-add { padding: 16px 20px; border-bottom: 1px solid rgba(201,168,76,0.1); text-align: center; }
  .bm-add-hint { font-size: 0.62rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.35); margin-bottom: 10px; }
  .btn-add-funds {
    font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; letter-spacing: 3px;
    text-transform: uppercase; padding: 11px 32px;
    background: linear-gradient(135deg, #1a5c30, #27ae60);
    color: #fff; border: none; cursor: pointer;
    box-shadow: 0 4px 18px rgba(0,0,0,0.4); transition: all 0.2s;
    touch-action: manipulation; min-height: 44px;
  }
  .btn-add-funds:hover { transform: translateY(-1px); box-shadow: 0 6px 22px rgba(39,174,96,0.3); }

  .bm-tx-title { font-size: 0.62rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.4); padding: 14px 20px 8px; }
  .bm-tx-list { max-height: 220px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(201,168,76,0.2) transparent; }
  .bm-tx-list::-webkit-scrollbar { width: 4px; }
  .bm-tx-list::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.2); }

  .tx-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.88rem; }
  .tx-row:last-child { border-bottom: none; }
  .tx-row:nth-child(even) { background: rgba(255,255,255,0.02); }
  .tx-info-desc { color: rgba(232,224,208,0.65); }
  .tx-info-time { font-size: 0.66rem; color: rgba(201,168,76,0.3); margin-top: 2px; }
  .tx-amount { font-family: 'Playfair Display', serif; font-size: 0.95rem; }
  .tx-amount.credit { color: #2ecc71; }
  .tx-amount.debit  { color: #e74c3c; }
  .bm-empty { text-align: center; padding: 24px; color: rgba(201,168,76,0.3); font-style: italic; font-size: 0.95rem; }

  /* ULTIMATE BONUS MODAL */
  .bonus-modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  .bonus-modal-overlay.open { display: flex; }
  .bonus-modal {
    background: #0e0e0e;
    border: 1px solid rgba(201,168,76,0.3);
    width: 100%;
    max-width: 520px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.9);
    animation: fadeIn 0.2s ease;
    position: relative;
  }
  .bonus-modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
  .bm2-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 22px 14px; border-bottom: 1px solid rgba(201,168,76,0.12); position: sticky; top: 0; background: #0e0e0e; z-index: 1; }
  .bm2-title { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.15rem; letter-spacing: 3px; }
  .bm2-close { background: none; border: none; color: rgba(201,168,76,0.5); font-size: 1.4rem; cursor: pointer; padding: 4px; transition: color 0.2s; }
  .bm2-close:hover { color: var(--gold); }
  .bonus-table { width: 100%; border-collapse: collapse; }
  .bonus-table th { color: rgba(201,168,76,0.55); font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; padding: 10px 16px; text-align: left; border-bottom: 1px solid rgba(201,168,76,0.15); }
  .bonus-table td { padding: 9px 16px; color: rgba(232,224,208,0.75); font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .bonus-table tr:last-child td { border-bottom: none; }
  .bonus-table tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
  .bonus-hand { color: var(--gold-light); font-family: 'Playfair Display', serif; font-size: 0.95rem; }
  .bonus-pay { color: #e8d08a; font-weight: 500; }

  /* HEADER */
  header {
    text-align: center;
    padding: clamp(24px, 6vw, 48px) 20px clamp(16px, 4vw, 32px);
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }
  .header-ornament { color: var(--gold); font-size: 14px; letter-spacing: 8px; text-transform: uppercase; opacity: 0.7; margin-bottom: 12px; }
  h1 { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 6vw, 5rem); color: var(--gold); letter-spacing: 0.1em; line-height: 1; text-shadow: 0 0 40px rgba(201,168,76,0.3); }
  h1 span { font-style: italic; font-size: 0.6em; display: block; color: var(--gold-light); letter-spacing: 0.3em; margin-top: 6px; }
  .gold-line { width: 120px; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 20px auto; }

  /* NAV */
  nav { display: flex; justify-content: center; gap: 0; padding: 0 8px; border-bottom: 1px solid rgba(201,168,76,0.2); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  nav::-webkit-scrollbar { display: none; }

  .tab-btn {
    background: none; border: none; color: rgba(232,208,138,0.5);
    font-family: 'Cormorant Garamond', serif; font-size: 1rem;
    letter-spacing: 4px; text-transform: uppercase; padding: 16px 24px;
    cursor: pointer; position: relative; transition: color 0.3s; white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  @media (max-width: 480px) { .tab-btn { font-size: 0.85rem; letter-spacing: 2px; padding: 14px 16px; } }
  .tab-btn::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--gold); transform: scaleX(0); transition: transform 0.3s; }
  .tab-btn.active { color: var(--gold); }
  .tab-btn.active::after { transform: scaleX(1); }

  /* SECTIONS */
  .section { display: none; max-width: 1100px; margin: 0 auto; padding: clamp(20px, 5vw, 40px) clamp(12px, 4vw, 20px); animation: fadeIn 0.4s ease; }
  .section.active { display: block; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* GAME */
  .game-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }

  /* Speed toggle */
  .speed-toggle { display: flex; gap: 0; border: 1px solid rgba(201,168,76,0.25); overflow: hidden; align-self: flex-end; }
  .speed-btn { font-family: 'Cormorant Garamond', serif; font-size: 0.75rem; letter-spacing: 3px; text-transform: uppercase; padding: 8px 18px; background: none; border: none; color: rgba(201,168,76,0.45); cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; min-height: 38px; }
  .speed-btn.active { background: rgba(201,168,76,0.12); color: var(--gold); }
  .speed-btn + .speed-btn { border-left: 1px solid rgba(201,168,76,0.2); }

  /* Bet area */
  .bet-area {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 16px;
    align-items: center;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(201,168,76,0.15);
    padding: 16px 20px;
    width: 100%;
    max-width: 800px;
  }
  @media (max-width: 600px) {
    .bet-area { grid-template-columns: 1fr 1fr; }
    .bet-input-wrap { grid-column: 1 / -1; order: -1; }
  }

  .balance-display { text-align: center; }
  .balance-label { font-size: 0.7rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.6); }
  .balance-amount { font-family: 'Playfair Display', serif; font-size: clamp(1.2rem, 4vw, 1.8rem); color: var(--gold); text-shadow: 0 0 20px rgba(201,168,76,0.4); }

  .bet-input-wrap { display: flex; flex-direction: column; align-items: center; gap: 8px; }
  .bet-input-label { font-size: 0.68rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.5); }

  .bet-inputs-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
  .bet-input-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .bet-input-sublabel { font-size: 0.6rem; letter-spacing: 2px; text-transform: uppercase; color: rgba(201,168,76,0.4); }

  .bet-input {
    font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--gold);
    background: rgba(201,168,76,0.06); border: 1px solid rgba(201,168,76,0.3);
    padding: 8px 10px; width: 110px; text-align: center; outline: none; transition: border-color 0.2s;
  }
  .bet-input:focus { border-color: var(--gold); }
  .bet-input::placeholder { color: rgba(201,168,76,0.25); font-size: 0.9rem; }
  .bet-input::-webkit-outer-spin-button, .bet-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .bet-input[type=number] { -moz-appearance: textfield; }

  .quick-bets { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
  .quick-bet-btn {
    font-family: 'Cormorant Garamond', serif; font-size: 0.72rem; letter-spacing: 1px;
    padding: 5px 10px; background: rgba(201,168,76,0.07); border: 1px solid rgba(201,168,76,0.2);
    color: rgba(201,168,76,0.6); cursor: pointer; transition: all 0.15s; min-height: 30px;
    -webkit-tap-highlight-color: transparent;
  }
  .quick-bet-btn:hover { background: rgba(201,168,76,0.15); color: var(--gold); border-color: rgba(201,168,76,0.5); }

  /* FELT TABLE */
  .felt-table {
    width: 100%;
    max-width: 800px;
    background: var(--green-felt);
    border: 3px solid var(--gold-dark);
    box-shadow: 0 0 60px rgba(0,0,0,0.8), inset 0 0 80px rgba(0,0,0,0.2);
    padding: clamp(14px, 4vw, 28px);
    position: relative;
    border-radius: 4px;
    overflow: hidden;
  }
  .felt-table::before { content: ''; position: absolute; inset: 6px; border: 1px solid rgba(201,168,76,0.2); pointer-events: none; }

  .hand-area { text-align: center; margin-bottom: 20px; }
  .hand-label { font-family: 'Playfair Display', serif; font-size: clamp(0.6rem, 2vw, 0.75rem); letter-spacing: clamp(2px, 1vw, 5px); text-transform: uppercase; color: rgba(201,168,76,0.7); margin-bottom: 10px; }

  /* SPLIT HANDS */
  .split-container { display: flex; gap: 16px; justify-content: center; }
  .split-hand {
    flex: 1;
    border: 1px solid rgba(201,168,76,0.2);
    padding: 10px;
    position: relative;
    transition: border-color 0.3s;
    min-width: 0;
  }
  .split-hand.active-hand { border-color: var(--gold); box-shadow: 0 0 16px rgba(201,168,76,0.25); }
  .split-hand-label { font-size: 0.6rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(201,168,76,0.5); margin-bottom: 8px; }
  .split-hand-bet { font-size: 0.75rem; color: rgba(201,168,76,0.6); margin-bottom: 6px; }

  .cards-row {
    display: flex;
    gap: clamp(6px, 2vw, 10px);
    justify-content: center;
    min-height: clamp(76px, 18vw, 100px);
    align-items: center;
    flex-wrap: wrap;
    overflow: visible;
  }
  .score-display { margin-top: 10px; font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--gold); }
  .score-display.bust { color: #e74c3c; }
  .score-display.blackjack-score { color: #2ecc71; }

  /* CARDS */
  .playing-card {
    width: clamp(52px, 12vw, 68px);
    height: clamp(76px, 17vw, 100px);
    background: var(--card-bg);
    border-radius: 5px;
    box-shadow: 2px 4px 12px rgba(0,0,0,0.5);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    font-size: clamp(0.75rem, 2.5vw, 1.1rem);
    font-weight: 700;
    animation: dealCard var(--deal-duration, 0.3s) ease;
    transform-origin: bottom center;
    flex-shrink: 0;
  }
  @keyframes dealCard {
    from { opacity: 0; transform: scale(0.5) rotate(-5deg) translateY(-20px); }
    to   { opacity: 1; transform: scale(1) rotate(0deg) translateY(0); }
  }
  .card-corner-top { position: absolute; top: 4px; left: 5px; font-size: clamp(0.6rem, 1.8vw, 0.85rem); line-height: 1; }
  .card-corner-bottom { position: absolute; bottom: 4px; right: 5px; font-size: clamp(0.6rem, 1.8vw, 0.85rem); line-height: 1; transform: rotate(180deg); }
  .card-suit-center { font-size: clamp(1.2rem, 4vw, 1.8rem); }
  .card-red { color: var(--red); }
  .card-black { color: #1a1a1a; }
  .card-back { background: linear-gradient(135deg, #0a3d2e, #1a6b52); }
  .card-back .card-suit-center { color: rgba(201,168,76,0.5); font-size: 2rem; }

  /* RESULT */
  .result-msg {
    text-align: center;
    padding: 16px;
    background: rgba(0,0,0,0.5);
    border: 1px solid rgba(201,168,76,0.3);
    min-height: 58px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 16px;
  }
  .result-text { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--gold); letter-spacing: 2px; animation: fadeIn 0.5s ease; }
  .result-win { color: #2ecc71; text-shadow: 0 0 20px rgba(46,204,113,0.5); }
  .result-loss { color: #e74c3c; }
  .result-push { color: var(--gold); }

  /* ULTIMATE BET area */
  .ultimate-area {
    width: 100%;
    max-width: 800px;
    background: rgba(0,0,0,0.25);
    border: 1px dashed rgba(201,168,76,0.2);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .ultimate-info { flex: 1; min-width: 180px; }
  .ultimate-title { font-family: 'Playfair Display', serif; color: var(--gold-light); font-size: 1rem; letter-spacing: 2px; }
  .ultimate-desc { font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; color: rgba(201,168,76,0.4); margin-top: 4px; }
  .ultimate-input-wrap { display: flex; flex-direction: column; align-items: center; gap: 6px; }
  .ultimate-input {
    font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold-light);
    background: rgba(201,168,76,0.06); border: 1px dashed rgba(201,168,76,0.25);
    padding: 7px 12px; width: 110px; text-align: center; outline: none; transition: border-color 0.2s;
  }
  .ultimate-input:focus { border-color: var(--gold); }
  .ultimate-input::-webkit-outer-spin-button, .ultimate-input::-webkit-inner-spin-button { -webkit-appearance: none; }
  .ultimate-input[type=number] { -moz-appearance: textfield; }
  .ultimate-info-btn { font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(201,168,76,0.35); background: none; border: none; cursor: pointer; padding: 4px 8px; transition: color 0.2s; }
  .ultimate-info-btn:hover { color: rgba(201,168,76,0.7); }

  /* ACTIONS */
  .action-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; max-width: 800px; }

  .btn-primary {
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 4px;
    text-transform: uppercase; padding: 14px 28px;
    background: linear-gradient(135deg, var(--gold-dark), var(--gold));
    color: var(--darker); border: none; cursor: pointer; transition: all 0.2s;
    font-weight: 600; box-shadow: 0 4px 20px rgba(201,168,76,0.3);
    touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 48px;
  }
  .btn-secondary {
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 3px;
    text-transform: uppercase; padding: 14px 20px; background: transparent;
    color: var(--gold); border: 1px solid rgba(201,168,76,0.4); cursor: pointer;
    transition: all 0.2s; font-weight: 400; touch-action: manipulation;
    -webkit-tap-highlight-color: transparent; min-height: 48px;
  }
  .btn-danger {
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 3px;
    text-transform: uppercase; padding: 14px 20px;
    background: rgba(192,57,43,0.15); color: #e74c3c;
    border: 1px solid rgba(192,57,43,0.4); cursor: pointer; transition: all 0.2s;
    touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 48px;
  }
  .btn-split {
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 3px;
    text-transform: uppercase; padding: 14px 20px;
    background: rgba(41,128,185,0.15); color: #2980b9;
    border: 1px solid rgba(41,128,185,0.4); cursor: pointer; transition: all 0.2s;
    touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 48px;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(201,168,76,0.4); }
  .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
  .btn-secondary:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }
  .btn-danger:hover { background: rgba(192,57,43,0.25); }
  .btn-split:hover { background: rgba(41,128,185,0.25); }
  @media (max-width: 400px) { .btn-primary, .btn-secondary, .btn-danger, .btn-split { letter-spacing: 2px; padding: 12px 14px; font-size: 0.85rem; } }

  /* DECK indicator */
  .deck-indicator { font-size: 0.65rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.35); text-align: center; }

  /* STATS */
  .section-title { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 2rem; text-align: center; letter-spacing: 3px; }

  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .stat-card { background: linear-gradient(135deg, rgba(10,61,46,0.3), rgba(0,0,0,0.3)); border: 1px solid rgba(201,168,76,0.2); padding: 24px 16px; text-align: center; position: relative; }
  .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
  .stat-value { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--gold); display: block; }
  .stat-label { font-size: 0.7rem; letter-spacing: 4px; text-transform: uppercase; color: rgba(201,168,76,0.5); margin-top: 6px; display: block; }

  .win-bar-wrap { margin-bottom: 32px; }
  .win-bar-labels { display: flex; justify-content: space-between; font-size: 0.75rem; letter-spacing: 3px; color: rgba(201,168,76,0.5); text-transform: uppercase; margin-bottom: 8px; }
  .win-bar-track { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; display: flex; }
  .win-bar-wins { background: #2ecc71; transition: width 0.5s; }
  .win-bar-losses { background: #e74c3c; transition: width 0.5s; }
  .win-bar-push { background: var(--gold-dark); transition: width 0.5s; }

  .history-title { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.3rem; letter-spacing: 3px; margin-bottom: 16px; text-align: center; }
  .history-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid rgba(201,168,76,0.1); }
  .history-table { width: 100%; min-width: 480px; border-collapse: collapse; font-size: 0.95rem; }
  .history-table th { color: rgba(201,168,76,0.6); font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; padding: 10px 14px; border-bottom: 1px solid rgba(201,168,76,0.2); text-align: left; }
  .history-table td { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); color: rgba(232,224,208,0.8); }
  .history-table tr:hover td { background: rgba(201,168,76,0.04); }

  .pill { display: inline-block; padding: 2px 10px; border-radius: 2px; font-size: 0.8rem; letter-spacing: 1px; }
  .pill-win { background: rgba(46,204,113,0.15); color: #2ecc71; }
  .pill-loss { background: rgba(231,76,60,0.15); color: #e74c3c; }
  .pill-bj { background: rgba(201,168,76,0.2); color: var(--gold); }
  .pill-push { background: rgba(41,128,185,0.15); color: #2980b9; }

  .empty-history { text-align: center; padding: 40px; color: rgba(201,168,76,0.3); font-style: italic; font-size: 1.1rem; }
  .reset-btn { display: block; margin: 20px auto 0; background: none; border: 1px solid rgba(192,57,43,0.3); color: rgba(192,57,43,0.6); font-family: 'Cormorant Garamond', serif; letter-spacing: 3px; font-size: 0.8rem; text-transform: uppercase; padding: 8px 24px; cursor: pointer; transition: all 0.2s; }
  .reset-btn:hover { border-color: #c0392b; color: #c0392b; }

  /* RULES */
  .rules-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-top: 32px; }
  @media (max-width: 700px) { .rules-grid { grid-template-columns: 1fr; } }
  .rule-card { background: linear-gradient(135deg, rgba(201,168,76,0.05), rgba(10,61,46,0.2)); border: 1px solid rgba(201,168,76,0.2); padding: 28px; position: relative; overflow: hidden; }
  .rule-card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: linear-gradient(180deg, var(--gold), transparent); }
  .rule-card h3 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.2rem; margin-bottom: 16px; letter-spacing: 2px; }
  .rule-card p, .rule-card li { font-size: 1rem; line-height: 1.8; color: rgba(232,224,208,0.85); font-weight: 300; }
  .rule-card ul { padding-left: 20px; }
  .rule-card li { margin-bottom: 6px; }

  /* FOOTER */
  .games-footer { margin-top: 60px; border-top: 1px solid rgba(201,168,76,0.15); padding: 36px 20px 48px; }
  .games-footer-title { text-align: center; font-size: 0.7rem; letter-spacing: 6px; text-transform: uppercase; color: rgba(201,168,76,0.4); margin-bottom: 24px; }
  .games-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 700px; margin: 0 auto; }
  @media (max-width: 500px) { .games-grid { grid-template-columns: 1fr; max-width: 300px; } }
  .game-card-link { display: block; text-decoration: none; border: 1px solid rgba(201,168,76,0.15); padding: 20px 12px; text-align: center; transition: all 0.25s; position: relative; overflow: hidden; background: rgba(0,0,0,0.2); -webkit-tap-highlight-color: transparent; }
  .game-card-link::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(201,168,76,0.05), transparent); opacity: 0; transition: opacity 0.25s; }
  .game-card-link:hover { border-color: rgba(201,168,76,0.5); transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.4); }
  .game-card-link:hover::before { opacity: 1; }
  .game-card-icon { font-size: 2rem; display: block; margin-bottom: 8px; line-height: 1; }
  .game-card-name { font-family: 'Playfair Display', serif; font-size: 1rem; color: rgba(201,168,76,0.8); letter-spacing: 2px; display: block; }
  .game-card-sub { font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(201,168,76,0.35); display: block; margin-top: 4px; }

  /* TOAST */
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(10,10,10,0.95); border: 1px solid rgba(201,168,76,0.4); color: var(--gold); font-family: 'Playfair Display', serif; font-size: 1rem; letter-spacing: 2px; padding: 14px 24px; z-index: 9999; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); white-space: normal; max-width: calc(100vw - 40px); text-align: center; }
  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- BALANCE MODAL -->
<div class="balance-modal-overlay" id="balanceModalOverlay" onclick="closeBalanceModalOnBg(event)">
  <div class="balance-modal">
    <div class="bm-header">
      <span class="bm-title">–ë–∞–ª–∞–Ω—Å</span>
      <button class="bm-close" onclick="closeBalanceModal()">‚úï</button>
    </div>
    <div class="bm-amount">
      <div class="bm-amount-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="bm-amount-value" id="bmAmount">‚ÇΩ ‚Äî</div>
    </div>
    <div class="bm-add">
      <div class="bm-add-hint">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <button class="btn-add-funds" onclick="addFunds()">+ 10 000</button>
    </div>
    <div class="bm-tx-title">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
    <div class="bm-tx-list" id="bmTxList"><div class="bm-empty">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
  </div>
</div>

<!-- ULTIMATE BONUS MODAL -->
<div class="bonus-modal-overlay" id="bonusModalOverlay" onclick="closeBonusModalOnBg(event)">
  <div class="bonus-modal">
    <div class="bm2-header">
      <span class="bm2-title">Ultimate Bonus</span>
      <button class="bm2-close" onclick="closeBonusModal()">‚úï</button>
    </div>
    <div style="padding:20px;">
      <p style="font-size:0.9rem;color:rgba(232,224,208,0.65);line-height:1.7;margin-bottom:20px;">Ultimate Bonus ‚Äî –±–æ–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Å–æ–±—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏—è—Ö –∫–∞—Ä—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Å—Ö–æ–¥–∞.</p>
      <table class="bonus-table">
        <tr><th>–ö–æ–º–±–∏–Ω–∞—Ü–∏—è</th><th>–í—ã–ø–ª–∞—Ç–∞</th></tr>
        <tr><td class="bonus-hand">7‚ô¶ 7‚ô¶ + 7‚ô¶ —É –¥–∏–ª–µ—Ä–∞</td><td class="bonus-pay">1000:1</td></tr>
        <tr><td class="bonus-hand">K‚ô† K‚ô† + Blackjack –¥–∏–ª–µ—Ä–∞</td><td class="bonus-pay">1000:1</td></tr>
        <tr><td class="bonus-hand">K‚ô† K‚ô†</td><td class="bonus-pay">100:1</td></tr>
        <tr><td class="bonus-hand">‚ô†7 ‚ô£7 ‚ô¶7 (—Ä–∞–∑–Ω—ã–µ –º–∞—Å—Ç–∏)</td><td class="bonus-pay">50:1</td></tr>
        <tr><td class="bonus-hand">KK –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</td><td class="bonus-pay">30:1</td></tr>
        <tr><td class="bonus-hand">QQ –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</td><td class="bonus-pay">25:1</td></tr>
        <tr><td class="bonus-hand">JJ –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</td><td class="bonus-pay">25:1</td></tr>
        <tr><td>–î—Ä—É–≥–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏</td><td style="color:#e74c3c;">–ü—Ä–æ–∏–≥—Ä—ã—à</td></tr>
      </table>
    </div>
  </div>
</div>

<div class="top-bar">
  <a href="index.html" class="back-link">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
  </a>
  <span class="top-bar-title">Royal Casino</span>
  <div class="top-bar-balance" onclick="openBalanceModal()">
    <span class="tbl-label">–ë–∞–ª–∞–Ω—Å</span>
    <span class="tbl-amount" id="topbar-balance">‚ÇΩ ‚Äî</span>
  </div>
</div>

<header>
  <div class="header-ornament">‚ú¶ &nbsp; Royal Casino &nbsp; ‚ú¶</div>
  <h1>BLACKJACK<span>Classic 21</span></h1>
  <div class="gold-line"></div>
</header>

<nav>
  <button class="tab-btn active" onclick="showTab('game', this)">–ò–≥—Ä–∞</button>
  <button class="tab-btn" onclick="showTab('rules', this)">–ü—Ä–∞–≤–∏–ª–∞</button>
  <button class="tab-btn" onclick="showTab('stats', this)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
</nav>

<!-- ========== GAME TAB ========== -->
<div id="tab-game" class="section active">
  <div class="game-wrapper">

    <div class="speed-toggle">
      <button class="speed-btn" id="speed-slow" onclick="setSpeed('slow')">üïê –ú–µ–¥–ª–µ–Ω–Ω–æ</button>
      <button class="speed-btn active" id="speed-fast" onclick="setSpeed('fast')">‚ö° –ë—ã—Å—Ç—Ä–æ</button>
    </div>

    <!-- Bet Area -->
    <div class="bet-area">
      <div class="balance-display">
        <div class="balance-label">–ë–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount" id="balance-display">‚ÇΩ 10,000</div>
      </div>
      <div class="bet-input-wrap">
        <div class="bet-input-label">–°—Ç–∞–≤–∫–∞ (‚ÇΩ)</div>
        <div class="bet-inputs-row">
          <div class="bet-input-group">
            <span class="bet-input-sublabel">–û—Å–Ω–æ–≤–Ω–∞—è</span>
            <input class="bet-input" type="number" id="betInput" min="10" max="50000" placeholder="0" />
          </div>
        </div>
        <div class="quick-bets">
          <button class="quick-bet-btn" onclick="setQuickBet(100)">100</button>
          <button class="quick-bet-btn" onclick="setQuickBet(250)">250</button>
          <button class="quick-bet-btn" onclick="setQuickBet(500)">500</button>
          <button class="quick-bet-btn" onclick="setQuickBet(1000)">1K</button>
          <button class="quick-bet-btn" onclick="setQuickBet(5000)">5K</button>
          <button class="quick-bet-btn" onclick="setBetMax()">MAX</button>
        </div>
      </div>
      <div class="balance-display">
        <div class="balance-label">–ú–∏–Ω / –ú–∞–∫—Å</div>
        <div class="balance-amount" style="font-size:1rem;opacity:0.7;">‚ÇΩ10 / ‚ÇΩ50K</div>
      </div>
    </div>

    <!-- Ultimate Bet -->
    <div class="ultimate-area">
      <div class="ultimate-info">
        <div class="ultimate-title">‚ô¶ Ultimate Bonus</div>
        <div class="ultimate-desc">–ë–æ–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –Ω–∞ –æ—Å–æ–±—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏</div>
      </div>
      <div class="ultimate-input-wrap">
        <span class="bet-input-sublabel">Ultimate (‚ÇΩ)</span>
        <input class="ultimate-input" type="number" id="ultimateInput" min="0" max="10000" placeholder="0" />
      </div>
      <button class="ultimate-info-btn" onclick="openBonusModal()">‚Ñπ –¢–∞–±–ª–∏—Ü–∞ –≤—ã–ø–ª–∞—Ç</button>
    </div>

    <!-- Felt Table -->
    <div class="felt-table">
      <!-- Dealer -->
      <div class="hand-area">
        <div class="hand-label">–î–∏–ª–µ—Ä</div>
        <div class="cards-row" id="dealer-cards"></div>
        <div class="score-display" id="dealer-score"></div>
      </div>

      <div style="width:100%;height:1px;background:rgba(201,168,76,0.15);margin:12px 0;"></div>

      <!-- Player (supports split) -->
      <div class="hand-area">
        <div class="hand-label">–ò–≥—Ä–æ–∫</div>
        <div id="player-hands-container">
          <!-- single hand by default -->
          <div class="cards-row" id="player-cards"></div>
          <div class="score-display" id="player-score"></div>
        </div>
      </div>

      <div class="result-msg" id="result-msg">
        <span class="result-text" style="color:rgba(201,168,76,0.4);font-style:italic;">–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–∞–∑–¥–∞—Ç—å¬ª</span>
      </div>
    </div>

    <div class="deck-indicator" id="deck-indicator">–ö–∞—Ä—Ç—ã –≤ –∫–æ–ª–æ–¥–µ: ‚Äî</div>

    <!-- Actions -->
    <div class="action-row" id="action-row">
      <button class="btn-primary" id="deal-btn" onclick="startGame()">–†–∞–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—ã</button>
      <button class="btn-secondary" id="rebet-btn" onclick="rebet()" disabled>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>

  </div>
</div>

<!-- ========== RULES TAB ========== -->
<div id="tab-rules" class="section">
  <div class="section-title">–ü—Ä–∞–≤–∏–ª–∞ –ë–ª—ç–∫–¥–∂–µ–∫–∞</div>
  <div class="gold-line"></div>
  <div class="rules-grid">
    <div class="rule-card" style="grid-column:1/-1;">
      <h3>–¶–µ–ª—å –∏–≥—Ä—ã</h3>
      <p>–ù–∞–±—Ä–∞—Ç—å –æ—á–∫–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º —É –¥–∏–ª–µ—Ä–∞, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–≤ <strong style="color:var(--gold)">21</strong>. –ï—Å–ª–∏ –≤—ã –ø—Ä–µ–≤—ã—Å–∏—Ç–µ 21 ‚Äî ¬´–ø–µ—Ä–µ–±–æ—Ä¬ª –∏ –ø—Ä–æ–∏–≥—Ä—ã—à. –î–∏–ª–µ—Ä –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ —É –Ω–µ–≥–æ –Ω–µ –±—É–¥–µ—Ç –Ω–µ –º–µ–Ω–µ–µ 17 –æ—á–∫–æ–≤.</p>
    </div>
    <div class="rule-card">
      <h3>–°—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞—Ä—Ç</h3>
      <ul>
        <li>2‚Äì10: –Ω–æ–º–∏–Ω–∞–ª –∫–∞—Ä—Ç—ã</li>
        <li>J, Q, K: 10 –æ—á–∫–æ–≤</li>
        <li>–¢—É–∑ (A): 11 –∏–ª–∏ 1 –æ—á–∫–æ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</li>
      </ul>
    </div>
    <div class="rule-card">
      <h3>–í—ã–ø–ª–∞—Ç—ã</h3>
      <ul>
        <li><strong style="color:#2ecc71">–ü–æ–±–µ–¥–∞</strong> ‚Äî –≤—ã–ø–ª–∞—Ç–∞ 1:1</li>
        <li><strong style="color:var(--gold)">Blackjack (21 —Å 2 –∫–∞—Ä—Ç)</strong> ‚Äî –≤—ã–ø–ª–∞—Ç–∞ 3:2</li>
        <li><strong style="color:#2980b9">–ù–∏—á—å—è (Push)</strong> ‚Äî –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏</li>
        <li><strong style="color:#e74c3c">–ü–µ—Ä–µ–±–æ—Ä / –ü—Ä–æ–∏–≥—Ä—ã—à</strong> ‚Äî —Å—Ç–∞–≤–∫–∞ —Å–≥–æ—Ä–∞–µ—Ç</li>
      </ul>
    </div>
    <div class="rule-card">
      <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
      <ul>
        <li><strong style="color:var(--gold)">–í–∑—è—Ç—å</strong> ‚Äî –≤–∑—è—Ç—å –µ—â—ë –æ–¥–Ω—É –∫–∞—Ä—Ç—É</li>
        <li><strong style="color:var(--gold)">–°—Ç–æ–ø</strong> ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è, –¥–∏–ª–µ—Ä –≤—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç—ã</li>
        <li><strong style="color:var(--gold)">–£–¥–≤–æ–∏—Ç—å</strong> ‚Äî —É–¥–≤–æ–∏—Ç—å —Å—Ç–∞–≤–∫—É –∏ –≤–∑—è—Ç—å —Ä–æ–≤–Ω–æ –æ–¥–Ω—É –∫–∞—Ä—Ç—É</li>
        <li><strong style="color:#2980b9">–°–ø–ª–∏—Ç</strong> ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–∞—Ä—É –Ω–∞ –¥–≤–µ —Ä—É–∫–∏ (–∫–∞–∂–¥–∞—è –ø–æ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–∞–≤–∫–µ)</li>
      </ul>
    </div>
    <div class="rule-card">
      <h3>–°–ø–ª–∏—Ç (Split)</h3>
      <p>–ï—Å–ª–∏ –ø–µ—Ä–≤—ã–µ –¥–≤–µ –∫–∞—Ä—Ç—ã –æ–¥–Ω–æ–≥–æ —Ä–∞–Ω–≥–∞ ‚Äî –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏—Ö –Ω–∞ –¥–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä—É–∫–∏. –ö–∞–∂–¥–∞—è —Ä—É–∫–∞ –∏–≥—Ä–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ. –°–ø–ª–∏—Ç –¢—É–∑–æ–≤ –¥–∞—ë—Ç –ø–æ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–µ –Ω–∞ –∫–∞–∂–¥—É—é —Ä—É–∫—É.</p>
    </div>
    <div class="rule-card">
      <h3>–£–¥–≤–æ–µ–Ω–∏–µ</h3>
      <p>–ü–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –∫–∞—Ä—Ç –º–æ–∂–Ω–æ —É–¥–≤–æ–∏—Ç—å —Å—Ç–∞–≤–∫—É ‚Äî –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ä–æ–≤–Ω–æ –æ–¥–Ω—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ –∏–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è.</p>
    </div>
    <div class="rule-card" style="grid-column:1/-1;">
      <h3>Ultimate Bonus</h3>
      <p>–ë–æ–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –Ω–∞ –æ—Å–æ–±—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∫–∞—Ä—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–¢–∞–±–ª–∏—Ü–∞ –≤—ã–ø–ª–∞—Ç¬ª –≤ –∏–≥—Ä–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏. –í—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Å—Ö–æ–¥–∞.</p>
    </div>
  </div>
</div>

<!-- ========== STATS TAB ========== -->
<div id="tab-stats" class="section">
  <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="gold-line"></div>

  <div class="stats-grid">
    <div class="stat-card"><span class="stat-value" id="s-games">0</span><span class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</span></div>
    <div class="stat-card"><span class="stat-value" id="s-wins">0</span><span class="stat-label">–ü–æ–±–µ–¥</span></div>
    <div class="stat-card"><span class="stat-value" id="s-losses">0</span><span class="stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</span></div>
    <div class="stat-card"><span class="stat-value" id="s-pushes">0</span><span class="stat-label">–ù–∏—á—å–∏—Ö</span></div>
    <div class="stat-card"><span class="stat-value" id="s-blackjacks">0</span><span class="stat-label">Blackjack</span></div>
    <div class="stat-card"><span class="stat-value" id="s-pnl" style="color:var(--gold)">‚ÇΩ 0</span><span class="stat-label">–ß–∏—Å—Ç—ã–π P&L</span></div>
    <div class="stat-card"><span class="stat-value" id="s-winrate">0%</span><span class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥</span></div>
    <div class="stat-card"><span class="stat-value" id="s-splits">0</span><span class="stat-label">–°–ø–ª–∏—Ç–æ–≤</span></div>
  </div>

  <div class="win-bar-wrap">
    <div class="win-bar-labels">
      <span id="pct-wins">–ü–æ–±–µ–¥—ã 0%</span>
      <span id="pct-pushes">–ù–∏—á—å–∏ 0%</span>
      <span id="pct-losses">–ü–æ—Ä–∞–∂–µ–Ω–∏—è 0%</span>
    </div>
    <div class="win-bar-track">
      <div class="win-bar-wins" id="bar-wins" style="width:0%"></div>
      <div class="win-bar-push" id="bar-push" style="width:0%"></div>
      <div class="win-bar-losses" id="bar-losses" style="width:0%"></div>
    </div>
  </div>

  <div class="history-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤</div>
  <div id="history-container">
    <div class="empty-history" id="empty-history">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥!</div>
    <div class="history-table-wrap" id="history-table-wrap" style="display:none;">
      <table class="history-table">
        <thead><tr><th>#</th><th>–°—Ç–∞–≤–∫–∞</th><th>–ò—Å—Ö–æ–¥</th><th>P&L</th><th>–ò—Ç–æ–≥</th></tr></thead>
        <tbody id="history-body"></tbody>
      </table>
    </div>
  </div>
  <button class="reset-btn" onclick="resetStats()">‚ö† –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ==================== CONSTANTS ====================
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RED_SUITS = new Set(['‚ô•','‚ô¶']);
const BAL_KEY = 'casinoBalance';
const STATS_KEY = 'bj_stats_v2';
const TX_KEY = 'bjTxHistory';

// ==================== STATE ====================
let balance = parseInt(localStorage.getItem(BAL_KEY) || '10000');
let gameSpeed = 'fast';
let gameInProgress = false;
let deck = [];

// Game state
let dealerHand = [];
let playerHands = []; // array of hand objects
let currentHandIndex = 0;
let lastBet = 0;
let lastUltimateBet = 0;
let roundBet = 0;
let roundUltimateBet = 0;
let isSplit = false;

let stats = loadStats();
let txHistory = (() => { try { return JSON.parse(localStorage.getItem(TX_KEY) || '[]'); } catch(e) { return []; } })();

// ==================== HELPERS ====================
function cardVal(rank) {
  if (rank === 'A') return 11;
  if (['10','J','Q','K'].includes(rank)) return 10;
  return parseInt(rank);
}

function handTotal(cards) {
  let total = 0, aces = 0;
  for (const c of cards) {
    total += cardVal(c.rank);
    if (c.rank === 'A') aces++;
  }
  while (total > 21 && aces > 0) { total -= 10; aces--; }
  return total;
}

function newDeck() {
  const d = [];
  for (const s of SUITS) for (const r of RANKS) d.push({ rank: r, suit: s });
  for (let i = d.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [d[i], d[j]] = [d[j], d[i]];
  }
  return d;
}

function drawCard() {
  if (deck.length < 15) {
    deck = newDeck();
    showToast('–ö–æ–ª–æ–¥–∞ –ø–µ—Ä–µ–º–µ—à–∞–Ω–∞');
  }
  return deck.pop();
}

function isRed(suit) { return RED_SUITS.has(suit); }
function fmtMoney(n) { return '‚ÇΩ ' + n.toLocaleString('ru-RU'); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function t(ms) { return gameSpeed === 'slow' ? ms * 4 : ms; }

// ==================== SPEED ====================
function setSpeed(s) {
  gameSpeed = s;
  document.getElementById('speed-slow').classList.toggle('active', s === 'slow');
  document.getElementById('speed-fast').classList.toggle('active', s === 'fast');
}

// ==================== BALANCE MODAL ====================
function openBalanceModal() {
  renderBalanceModal();
  document.getElementById('balanceModalOverlay').classList.add('open');
}
function closeBalanceModal() { document.getElementById('balanceModalOverlay').classList.remove('open'); }
function closeBalanceModalOnBg(e) { if (e.target === document.getElementById('balanceModalOverlay')) closeBalanceModal(); }

function renderBalanceModal() {
  document.getElementById('bmAmount').textContent = fmtMoney(balance);
  const list = document.getElementById('bmTxList');
  if (!txHistory.length) { list.innerHTML = '<div class="bm-empty">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>'; return; }
  list.innerHTML = '';
  txHistory.forEach(tx => {
    const row = document.createElement('div');
    row.className = 'tx-row';
    const credit = tx.amount > 0;
    const d = new Date(tx.ts);
    const timeStr = d.toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit'}) + ' ' +
                    d.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
    row.innerHTML = `<div><div class="tx-info-desc">${tx.desc}</div><div class="tx-info-time">${timeStr}</div></div>
      <div class="tx-amount ${credit ? 'credit' : 'debit'}">${credit ? '+' : ''}${fmtMoney(tx.amount)}</div>`;
    list.appendChild(row);
  });
}

function addFunds() {
  balance += 10000;
  recordTx('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞', 10000);
  saveBalance();
  updateUI();
  renderBalanceModal();
  showToast('+ 10 000 –¥–æ–±–∞–≤–ª–µ–Ω–æ');
}

function recordTx(desc, amount) {
  txHistory.unshift({ desc, amount, ts: Date.now() });
  if (txHistory.length > 150) txHistory = txHistory.slice(0, 150);
  localStorage.setItem(TX_KEY, JSON.stringify(txHistory));
}

function saveBalance() { localStorage.setItem(BAL_KEY, balance); }

// ==================== BONUS MODAL ====================
function openBonusModal() { document.getElementById('bonusModalOverlay').classList.add('open'); }
function closeBonusModal() { document.getElementById('bonusModalOverlay').classList.remove('open'); }
function closeBonusModalOnBg(e) { if (e.target === document.getElementById('bonusModalOverlay')) closeBonusModal(); }

// ==================== TABS ====================
function showTab(name, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'stats') renderStats();
}

// ==================== BET HELPERS ====================
function setQuickBet(val) { document.getElementById('betInput').value = val; }
function setBetMax() { document.getElementById('betInput').value = Math.min(balance, 50000); }

// ==================== CARD RENDERING ====================
function makeCardEl(card, hidden = false) {
  const dur = gameSpeed === 'slow' ? '0.6s' : '0.25s';
  const div = document.createElement('div');
  div.className = 'playing-card';
  div.style.setProperty('--deal-duration', dur);
  if (hidden) {
    div.classList.add('card-back');
    div.innerHTML = `<div class="card-suit-center">‚ú¶</div>`;
  } else {
    const colorClass = isRed(card.suit) ? 'card-red' : 'card-black';
    div.innerHTML = `
      <div class="card-corner-top ${colorClass}">${card.rank}<br>${card.suit}</div>
      <div class="card-suit-center ${colorClass}">${card.suit}</div>
      <div class="card-corner-bottom ${colorClass}">${card.rank}<br>${card.suit}</div>
    `;
  }
  return div;
}

async function renderCardAnimated(card, container, hidden = false, delay = 0) {
  if (delay) await sleep(delay);
  const el = makeCardEl(card, hidden);
  container.appendChild(el);
  return el;
}

function revealHiddenCard(container, card) {
  const hiddenEl = container.querySelector('.card-back');
  if (!hiddenEl) return;
  const colorClass = isRed(card.suit) ? 'card-red' : 'card-black';
  hiddenEl.classList.remove('card-back');
  hiddenEl.innerHTML = `
    <div class="card-corner-top ${colorClass}">${card.rank}<br>${card.suit}</div>
    <div class="card-suit-center ${colorClass}">${card.suit}</div>
    <div class="card-corner-bottom ${colorClass}">${card.rank}<br>${card.suit}</div>
  `;
}

// ==================== UI UPDATE ====================
function updateUI() {
  document.getElementById('balance-display').textContent = fmtMoney(balance);
  document.getElementById('topbar-balance').textContent = fmtMoney(balance);
  document.getElementById('deck-indicator').textContent = `–ö–∞—Ä—Ç—ã –≤ –∫–æ–ª–æ–¥–µ: ${deck.length}`;
  saveBalance();
}

function setResult(html) {
  document.getElementById('result-msg').innerHTML = html;
}

function setActions(html) {
  document.getElementById('action-row').innerHTML = html;
}

// ==================== GAME LOGIC ====================
async function startGame() {
  const bet = parseInt(document.getElementById('betInput').value) || 0;
  const ubet = parseInt(document.getElementById('ultimateInput').value) || 0;

  if (bet < 10) { showToast('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ‚ÇΩ 10'); return; }
  if (bet > 50000) { showToast('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ‚ÇΩ 50,000'); return; }
  if (bet + ubet > balance) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }
  if (gameInProgress) return;

  gameInProgress = true;
  isSplit = false;
  roundBet = bet;
  roundUltimateBet = ubet;
  balance -= bet + ubet;
  updateUI();

  if (ubet > 0) recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî Ultimate Bonus —Å—Ç–∞–≤–∫–∞', -ubet);
  recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî —Å—Ç–∞–≤–∫–∞', -bet);

  // Reset board
  dealerHand = [];
  playerHands = [{ cards: [], bet: bet, doubled: false, done: false }];
  currentHandIndex = 0;

  const pContainer = document.getElementById('player-cards');
  const dContainer = document.getElementById('dealer-cards');
  pContainer.innerHTML = '';
  dContainer.innerHTML = '';
  document.getElementById('player-score').textContent = '';
  document.getElementById('dealer-score').textContent = '';
  document.getElementById('player-hands-container').innerHTML = '<div class="cards-row" id="player-cards"></div><div class="score-display" id="player-score"></div>';

  setResult('<span class="result-text" style="color:rgba(201,168,76,0.3);font-style:italic;">–†–∞–∑–¥–∞—á–∞...</span>');
  setActions('');

  // Draw initial 4 cards
  const pCards = document.getElementById('player-cards');
  const dCards = document.getElementById('dealer-cards');

  const c1 = drawCard(); playerHands[0].cards.push(c1);
  await renderCardAnimated(c1, pCards);
  await sleep(t(200));

  const c2 = drawCard(); dealerHand.push(c2);
  await renderCardAnimated(c2, dCards);
  await sleep(t(200));

  const c3 = drawCard(); playerHands[0].cards.push(c3);
  await renderCardAnimated(c3, pCards);
  await sleep(t(200));

  const hiddenCard = drawCard(); dealerHand.push(hiddenCard);
  await renderCardAnimated(hiddenCard, dCards, true);
  await sleep(t(300));

  updateScores(false);

  const pTotal = handTotal(playerHands[0].cards);

  // Check natural blackjack
  if (pTotal === 21) {
    await revealDealer(dCards);
    await dealerPlay(dCards);
    await finishGame();
    return;
  }

  showPlayerActions();
}

function updateScores(dealerRevealed) {
  const pTotal = handTotal(playerHands[0].cards);
  const pScoreEl = document.getElementById('player-score');
  pScoreEl.textContent = pTotal;
  pScoreEl.className = 'score-display' + (pTotal > 21 ? ' bust' : pTotal === 21 ? ' blackjack-score' : '');

  if (dealerRevealed) {
    const dTotal = handTotal(dealerHand);
    const dScoreEl = document.getElementById('dealer-score');
    dScoreEl.textContent = dTotal;
    dScoreEl.className = 'score-display' + (dTotal > 21 ? ' bust' : '');
  } else {
    const dScoreEl = document.getElementById('dealer-score');
    dScoreEl.textContent = cardVal(dealerHand[0].rank);
    dScoreEl.className = 'score-display';
  }
}

function canSplit() {
  const h = playerHands[currentHandIndex];
  return !isSplit && h.cards.length === 2 &&
    h.cards[0].rank === h.cards[1].rank &&
    balance >= h.bet;
}

function canDouble() {
  const h = playerHands[currentHandIndex];
  return !h.doubled && h.cards.length === 2 && balance >= h.bet;
}

function showPlayerActions() {
  const actions = [
    `<button class="btn-primary" onclick="hit()">–í–∑—è—Ç—å</button>`,
    `<button class="btn-secondary" onclick="stand()">–°—Ç–æ–ø</button>`,
    canDouble() ? `<button class="btn-secondary" onclick="doubleDown()">–£–¥–≤–æ–∏—Ç—å</button>` : '',
    canSplit() ? `<button class="btn-split" onclick="split()">–°–ø–ª–∏—Ç</button>` : '',
  ].join('');
  setActions(actions);
}

async function hit() {
  if (!gameInProgress) return;
  const hand = playerHands[currentHandIndex];
  const card = drawCard();
  hand.cards.push(card);
  updateUI();

  const container = isSplit
    ? document.getElementById('hand-cards-' + currentHandIndex)
    : document.getElementById('player-cards');

  await renderCardAnimated(card, container);
  await sleep(t(150));

  const total = handTotal(hand.cards);
  updateSplitScores();

  if (total >= 21) {
    if (total > 21) {
      if (isSplit) markSplitHandDone(currentHandIndex, '–ü–µ—Ä–µ–±–æ—Ä');
      else setResult('<span class="result-text result-loss">–ü–µ—Ä–µ–±–æ—Ä!</span>');
    }
    await advanceHand();
  } else {
    showPlayerActions();
  }
}

async function stand() {
  if (!gameInProgress) return;
  playerHands[currentHandIndex].done = true;
  await advanceHand();
}

async function doubleDown() {
  if (!gameInProgress) return;
  const hand = playerHands[currentHandIndex];
  if (balance < hand.bet) { showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —É–¥–≤–æ–µ–Ω–∏—è'); return; }
  balance -= hand.bet;
  hand.bet *= 2;
  hand.doubled = true;
  updateUI();

  const card = drawCard();
  hand.cards.push(card);

  const container = isSplit
    ? document.getElementById('hand-cards-' + currentHandIndex)
    : document.getElementById('player-cards');

  await renderCardAnimated(card, container);
  await sleep(t(200));
  updateSplitScores();

  const total = handTotal(hand.cards);
  if (total > 21 && isSplit) markSplitHandDone(currentHandIndex, '–ü–µ—Ä–µ–±–æ—Ä');

  hand.done = true;
  await advanceHand();
}

async function split() {
  if (!gameInProgress || !canSplit()) return;
  isSplit = true;
  const originalHand = playerHands[0];
  balance -= originalHand.bet;
  recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî —Å–ø–ª–∏—Ç –¥–æ–ø. —Å—Ç–∞–≤–∫–∞', -originalHand.bet);
  stats.splits = (stats.splits || 0) + 1;
  updateUI();

  // Create two hands
  const card1 = originalHand.cards[0];
  const card2 = originalHand.cards[1];
  playerHands = [
    { cards: [card1], bet: originalHand.bet, doubled: false, done: false },
    { cards: [card2], bet: originalHand.bet, doubled: false, done: false },
  ];
  currentHandIndex = 0;

  // Rebuild UI for split hands
  const container = document.getElementById('player-hands-container');
  container.innerHTML = `
    <div class="split-container">
      <div class="split-hand active-hand" id="split-hand-0">
        <div class="split-hand-label">–†—É–∫–∞ 1</div>
        <div class="split-hand-bet" id="hand-bet-0">${fmtMoney(playerHands[0].bet)}</div>
        <div class="cards-row" id="hand-cards-0"></div>
        <div class="score-display" id="hand-score-0"></div>
        <div class="split-hand-label" id="hand-result-0" style="margin-top:8px;color:var(--gold-light);font-size:0.75rem;min-height:1em;"></div>
      </div>
      <div class="split-hand" id="split-hand-1">
        <div class="split-hand-label">–†—É–∫–∞ 2</div>
        <div class="split-hand-bet" id="hand-bet-1">${fmtMoney(playerHands[1].bet)}</div>
        <div class="cards-row" id="hand-cards-1"></div>
        <div class="score-display" id="hand-score-1"></div>
        <div class="split-hand-label" id="hand-result-1" style="margin-top:8px;color:var(--gold-light);font-size:0.75rem;min-height:1em;"></div>
      </div>
    </div>
  `;

  // Deal first card to each hand
  await renderCardAnimated(card1, document.getElementById('hand-cards-0'));
  await sleep(t(200));
  await renderCardAnimated(card2, document.getElementById('hand-cards-1'));
  await sleep(t(200));

  // Draw extra card for hand 0
  const extra0 = drawCard();
  playerHands[0].cards.push(extra0);
  await renderCardAnimated(extra0, document.getElementById('hand-cards-0'));
  updateSplitScores();
  await sleep(t(200));

  // Ace split: only one card each
  if (card1.rank === 'A') {
    // Draw extra card for hand 1
    const extra1 = drawCard();
    playerHands[1].cards.push(extra1);
    await renderCardAnimated(extra1, document.getElementById('hand-cards-1'));
    updateSplitScores();
    await sleep(t(200));
    // Auto-stand both
    playerHands[0].done = true;
    playerHands[1].done = true;
    currentHandIndex = 2; // skip
    await finishSplitGame();
    return;
  }

  setResult('<span class="result-text" style="color:rgba(201,168,76,0.5);font-size:1rem;">–ò–≥—Ä–∞–µ—Ç –†—É–∫–∞ 1</span>');
  showPlayerActions();
}

function markSplitHandDone(idx, msg) {
  const el = document.getElementById('hand-result-' + idx);
  if (el) el.textContent = msg;
}

function updateSplitScores() {
  if (isSplit) {
    for (let i = 0; i < playerHands.length; i++) {
      const total = handTotal(playerHands[i].cards);
      const el = document.getElementById('hand-score-' + i);
      if (el) {
        el.textContent = total;
        el.className = 'score-display' + (total > 21 ? ' bust' : total === 21 ? ' blackjack-score' : '');
      }
    }
  } else {
    const total = handTotal(playerHands[0].cards);
    const el = document.getElementById('player-score');
    if (el) {
      el.textContent = total;
      el.className = 'score-display' + (total > 21 ? ' bust' : total === 21 ? ' blackjack-score' : '');
    }
  }
}

async function advanceHand() {
  if (isSplit) {
    // Mark current hand done and move to next
    playerHands[currentHandIndex].done = true;

    // Highlight current done, activate next
    document.getElementById('split-hand-' + currentHandIndex)?.classList.remove('active-hand');
    currentHandIndex++;

    if (currentHandIndex < playerHands.length) {
      document.getElementById('split-hand-' + currentHandIndex)?.classList.add('active-hand');
      setResult(`<span class="result-text" style="color:rgba(201,168,76,0.5);font-size:1rem;">–ò–≥—Ä–∞–µ—Ç –†—É–∫–∞ ${currentHandIndex + 1}</span>`);

      // Draw extra card for new hand
      const extra = drawCard();
      playerHands[currentHandIndex].cards.push(extra);
      await renderCardAnimated(extra, document.getElementById('hand-cards-' + currentHandIndex));
      updateSplitScores();
      await sleep(t(200));

      const total = handTotal(playerHands[currentHandIndex].cards);
      if (total === 21) {
        markSplitHandDone(currentHandIndex, 'Blackjack!');
        playerHands[currentHandIndex].done = true;
        await finishSplitGame();
      } else {
        showPlayerActions();
      }
    } else {
      await finishSplitGame();
    }
  } else {
    // Single hand: go to dealer
    const dContainer = document.getElementById('dealer-cards');
    await revealDealer(dContainer);
    await dealerPlay(dContainer);
    await finishGame();
  }
}

async function finishSplitGame() {
  const dContainer = document.getElementById('dealer-cards');
  await revealDealer(dContainer);
  await dealerPlay(dContainer);

  const dTotal = handTotal(dealerHand);
  const dBust = dTotal > 21;
  let totalPnl = 0;
  let wins = 0, losses = 0, pushes = 0;

  for (let i = 0; i < playerHands.length; i++) {
    const h = playerHands[i];
    const pTotal = handTotal(h.cards);
    const pBust = pTotal > 21;
    let pnl = 0, label = '';

    if (pBust) {
      label = '–ü–µ—Ä–µ–±–æ—Ä'; pnl = -h.bet; losses++;
    } else if (dBust || pTotal > dTotal) {
      const bj = h.cards.length === 2 && pTotal === 21;
      const win = bj ? Math.floor(h.bet * 1.5) : h.bet;
      balance += h.bet + win;
      recordTx(`–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî —Å–ø–ª–∏—Ç —Ä—É–∫–∞ ${i+1} –ø–æ–±–µ–¥–∞`, h.bet + win);
      pnl = win; label = bj ? 'Blackjack!' : '–ü–æ–±–µ–¥–∞!'; wins++;
    } else if (pTotal === dTotal) {
      balance += h.bet;
      recordTx(`–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî —Å–ø–ª–∏—Ç —Ä—É–∫–∞ ${i+1} –Ω–∏—á—å—è`, h.bet);
      pnl = 0; label = '–ù–∏—á—å—è'; pushes++;
    } else {
      pnl = -h.bet; label = '–ü—Ä–æ–∏–≥—Ä—ã—à'; losses++;
    }
    totalPnl += pnl;
    markSplitHandDone(i, label);
  }

  updateUI();
  updateScores(true);

  const pnlStr = totalPnl >= 0 ? `+${fmtMoney(totalPnl)}` : fmtMoney(totalPnl);
  const cls = totalPnl > 0 ? 'result-win' : totalPnl < 0 ? 'result-loss' : 'result-push';
  setResult(`<div><div class="result-text ${cls}">–°–ø–ª–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</div><div style="font-size:0.95rem;margin-top:4px;color:${totalPnl>=0?'#2ecc71':'#e74c3c'}">${pnlStr}</div></div>`);

  recordGame({ type: 'split', wins, losses, pushes, pnl: totalPnl });
  endRound();
}

async function revealDealer(dContainer) {
  revealHiddenCard(dContainer, dealerHand[1]);
  await sleep(t(300));
  updateScores(true);
}

async function dealerPlay(dContainer) {
  while (handTotal(dealerHand) < 17) {
    await sleep(t(400));
    const card = drawCard();
    dealerHand.push(card);
    await renderCardAnimated(card, dContainer);
    await sleep(t(200));
    updateScores(true);
  }
}

async function finishGame() {
  const pTotal = handTotal(playerHands[0].cards);
  const dTotal = handTotal(dealerHand);
  const bet = playerHands[0].bet;
  const ubet = roundUltimateBet;
  const pBust = pTotal > 21;
  const dBust = dTotal > 21;
  const isBlackjack = playerHands[0].cards.length === 2 && pTotal === 21;

  let pnl = 0;
  let resultLabel = '';
  let resultCls = '';

  if (pBust) {
    resultLabel = '–ü–µ—Ä–µ–±–æ—Ä!'; resultCls = 'result-loss'; pnl = -bet;
  } else if (dBust || pTotal > dTotal) {
    const winMult = isBlackjack ? 1.5 : 1;
    const win = Math.floor(bet * winMult);
    balance += bet + win;
    recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî ' + (isBlackjack ? 'BLACKJACK!' : '–ø–æ–±–µ–¥–∞'), bet + win);
    pnl = win;
    resultLabel = isBlackjack ? 'Blackjack! 3:2' : '–ü–æ–±–µ–¥–∞!';
    resultCls = 'result-win';
  } else if (pTotal === dTotal) {
    balance += bet;
    recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî –Ω–∏—á—å—è', bet);
    pnl = 0; resultLabel = '–ù–∏—á—å—è ‚Äî –≤–æ–∑–≤—Ä–∞—Ç'; resultCls = 'result-push';
  } else {
    pnl = -bet; resultLabel = '–ü—Ä–æ–∏–≥—Ä—ã—à'; resultCls = 'result-loss';
  }

  // Ultimate bonus
  let bonusPnl = 0;
  if (ubet > 0) {
    bonusPnl = calcUltimateBonus(playerHands[0].cards, dealerHand, ubet);
    if (bonusPnl > 0) {
      balance += bonusPnl;
      recordTx('–ë–ª—ç–∫–¥–∂–µ–∫ ‚Äî Ultimate Bonus –≤—ã–ø–ª–∞—Ç–∞', bonusPnl);
    }
  }

  const totalPnl = pnl + (bonusPnl - ubet);
  updateUI();

  const pnlStr = totalPnl >= 0 ? `+${fmtMoney(totalPnl)}` : fmtMoney(totalPnl);
  const bonusLine = bonusPnl > 0 ? `<div style="font-size:0.8rem;color:#e8d08a;margin-top:5px;">‚ô¶ Ultimate: +${fmtMoney(bonusPnl - ubet)}</div>` : '';
  setResult(`<div><div class="result-text ${resultCls}">${resultLabel}</div><div style="font-size:0.95rem;margin-top:4px;color:${totalPnl>=0?'#2ecc71':'#e74c3c'}">${pnlStr}</div>${bonusLine}</div>`);

  const outcome = pBust || pTotal < dTotal && !dBust ? 'loss' : (pTotal === dTotal ? 'push' : (isBlackjack ? 'blackjack' : 'win'));
  recordGame({ type: 'single', outcome, bet, pnl: totalPnl });
  endRound();
}

function endRound() {
  lastBet = roundBet;
  lastUltimateBet = roundUltimateBet;
  gameInProgress = false;
  setActions(`
    <button class="btn-primary" onclick="startGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button class="btn-secondary" id="rebet-btn" onclick="rebet()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
  `);
  if (balance <= 0) {
    setTimeout(() => {
      showToast('–ë–∞–ª–∞–Ω—Å –∏—Å—á–µ—Ä–ø–∞–Ω! +‚ÇΩ 10,000');
      balance = 10000;
      recordTx('–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞', 10000);
      updateUI();
    }, t(600));
  }
}

function rebet() {
  if (lastBet > 0 && lastBet + lastUltimateBet <= balance) {
    document.getElementById('betInput').value = lastBet;
    document.getElementById('ultimateInput').value = lastUltimateBet;
    startGame();
  } else {
    showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞');
  }
}

// ==================== ULTIMATE BONUS ====================
function calcUltimateBonus(playerCards, dealerCards, ubet) {
  const kspades = playerCards.filter(c => c.rank === 'K' && c.suit === '‚ô†');
  if (kspades.length >= 2) {
    const dTotal = handTotal(dealerCards);
    if (dealerCards.length === 2 && dTotal === 21) return ubet * 1000;
    return ubet * 100;
  }
  const pd7 = playerCards.filter(c => c.rank === '7' && c.suit === '‚ô¶');
  const dd7 = dealerCards.filter(c => c.rank === '7' && c.suit === '‚ô¶');
  if (pd7.length >= 2 && dd7.length >= 1) return ubet * 1000;

  const sevens = playerCards.filter(c => c.rank === '7');
  if (sevens.length >= 3) {
    const ss = new Set(sevens.map(c => c.suit));
    if (ss.has('‚ô†') && ss.has('‚ô£') && ss.has('‚ô¶')) return ubet * 50;
  }
  const kings = playerCards.filter(c => c.rank === 'K');
  if (kings.length >= 2 && new Set(kings.map(c => c.suit)).size === 1) return ubet * 30;

  for (const r of ['Q', 'J']) {
    const cs = playerCards.filter(c => c.rank === r);
    if (cs.length >= 2 && new Set(cs.map(c => c.suit)).size === 1) return ubet * 25;
  }
  return 0;
}

// ==================== STATS ====================
function loadStats() {
  try {
    const raw = localStorage.getItem(STATS_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { games: 0, wins: 0, losses: 0, pushes: 0, blackjacks: 0, splits: 0, pnl: 0, rounds: [] };
}

function saveStats() { localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }

function recordGame(info) {
  stats.games++;
  stats.pnl += info.pnl;
  let outcome = '', bet = 0;
  let pnl = info.pnl;

  if (info.type === 'single') {
    bet = info.bet;
    outcome = info.outcome;
    if (outcome === 'win' || outcome === 'blackjack') stats.wins++;
    else if (outcome === 'loss') stats.losses++;
    else stats.pushes++;
    if (outcome === 'blackjack') stats.blackjacks++;
  } else {
    // split
    stats.wins += info.wins;
    stats.losses += info.losses;
    stats.pushes += info.pushes;
    outcome = 'split';
  }

  const pillMap = { win: 'pill-win', loss: 'pill-loss', push: 'pill-push', blackjack: 'pill-bj', split: 'pill-push' };
  const labelMap = { win: '–ü–æ–±–µ–¥–∞', loss: '–ü—Ä–æ–∏–≥—Ä—ã—à', push: '–ù–∏—á—å—è', blackjack: 'Blackjack', split: '–°–ø–ª–∏—Ç' };

  stats.rounds.unshift({
    n: stats.games,
    bet: bet || roundBet,
    outcome,
    pill: pillMap[outcome] || 'pill-push',
    label: labelMap[outcome] || outcome,
    pnl,
    dealer: handTotal(dealerHand),
    player: isSplit ? '‚Äî' : handTotal(playerHands[0]?.cards || []),
  });
  if (stats.rounds.length > 100) stats.rounds = stats.rounds.slice(0, 100);
  saveStats();
}

function renderStats() {
  document.getElementById('s-games').textContent = stats.games;
  document.getElementById('s-wins').textContent = stats.wins;
  document.getElementById('s-losses').textContent = stats.losses;
  document.getElementById('s-pushes').textContent = stats.pushes;
  document.getElementById('s-blackjacks').textContent = stats.blackjacks;
  document.getElementById('s-splits').textContent = stats.splits || 0;

  const pnlEl = document.getElementById('s-pnl');
  pnlEl.textContent = (stats.pnl >= 0 ? '+' : '') + fmtMoney(stats.pnl);
  pnlEl.style.color = stats.pnl >= 0 ? '#2ecc71' : '#e74c3c';

  const total = stats.wins + stats.losses + stats.pushes;
  const winrate = total > 0 ? Math.round(stats.wins / total * 100) : 0;
  document.getElementById('s-winrate').textContent = winrate + '%';

  const wPct = total > 0 ? Math.round(stats.wins / total * 100) : 0;
  const lPct = total > 0 ? Math.round(stats.losses / total * 100) : 0;
  const pPct = total > 0 ? Math.round(stats.pushes / total * 100) : 0;

  document.getElementById('bar-wins').style.width = wPct + '%';
  document.getElementById('bar-losses').style.width = lPct + '%';
  document.getElementById('bar-push').style.width = pPct + '%';
  document.getElementById('pct-wins').textContent = `–ü–æ–±–µ–¥—ã ${wPct}%`;
  document.getElementById('pct-losses').textContent = `–ü–æ—Ä–∞–∂–µ–Ω–∏—è ${lPct}%`;
  document.getElementById('pct-pushes').textContent = `–ù–∏—á—å–∏ ${pPct}%`;

  const empty = document.getElementById('empty-history');
  const wrap = document.getElementById('history-table-wrap');
  const tbody = document.getElementById('history-body');
  if (!stats.rounds.length) {
    empty.style.display = 'block'; wrap.style.display = 'none'; return;
  }
  empty.style.display = 'none'; wrap.style.display = 'block';
  tbody.innerHTML = '';
  stats.rounds.forEach(r => {
    const pnlStr = (r.pnl >= 0 ? '+' : '') + fmtMoney(r.pnl);
    const pnlColor = r.pnl > 0 ? '#2ecc71' : r.pnl < 0 ? '#e74c3c' : 'var(--gold)';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="opacity:0.5">#${r.n}</td>
      <td>${fmtMoney(r.bet)}</td>
      <td><span class="pill ${r.pill}">${r.label}</span></td>
      <td style="color:${pnlColor}">${pnlStr}</td>
      <td style="font-family:'Playfair Display',serif;color:var(--gold)">${r.player} ‚Äî ${r.dealer}</td>
    `;
    tbody.appendChild(tr);
  });
}

function resetStats() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
  stats = { games: 0, wins: 0, losses: 0, pushes: 0, blackjacks: 0, splits: 0, pnl: 0, rounds: [] };
  saveStats();
  renderStats();
  showToast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
}

// ==================== TOAST ====================
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ==================== INIT ====================
deck = newDeck();
updateUI();
</script>

<footer class="games-footer">
  <div class="games-footer-title">–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</div>
  <div class="games-grid">
    <a href="baccarat.html" class="game-card-link">
      <span class="game-card-icon">üÉè</span>
      <span class="game-card-name">Baccarat</span>
      <span class="game-card-sub">Royal Table</span>
    </a>
    <a href="roulette.html" class="game-card-link">
      <span class="game-card-icon">üé∞</span>
      <span class="game-card-name">Roulette</span>
      <span class="game-card-sub">European</span>
    </a>
    <a href="poker.html" class="game-card-link">
      <span class="game-card-icon">‚ô†Ô∏è</span>
      <span class="game-card-name">Poker</span>
      <span class="game-card-sub">Texas Hold'em</span>
    </a>
  </div>
</footer>

</body>
</html>
