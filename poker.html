<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Poker ‚Äî Royal Table</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-light: #e8d08a;
    --gold-dark: #8b6914;
    --green: #0a3d2e;
    --green-felt: #0d4d38;
    --dark: #0a0a0a;
    --darker: #050505;
    --card-bg: #faf8f0;
    --text: #e8e0d0;
    --red: #c0392b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cormorant Garamond', serif;
    background: var(--darker);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* ===== TOP BAR ===== */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
    background: rgba(0,0,0,0.5);
    border-bottom: 1px solid rgba(201,168,76,0.1);
    position: sticky;
    top: 0;
    z-index: 500;
    backdrop-filter: blur(8px);
    gap: 10px;
  }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: rgba(201,168,76,0.6);
    text-decoration: none;
    font-size: 0.75rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    transition: color 0.2s;
    font-family: 'Cormorant Garamond', serif;
    -webkit-tap-highlight-color: transparent;
    white-space: nowrap;
  }
  .back-link:hover { color: var(--gold); }
  .back-link svg { transition: transform 0.2s; flex-shrink: 0; }
  .back-link:hover svg { transform: translateX(-3px); }
  .top-bar-title { font-size: 0.65rem; letter-spacing: 5px; text-transform: uppercase; color: rgba(201,168,76,0.3); white-space: nowrap; }
  .top-bar-right { display: flex; align-items: center; gap: 8px; }
  .audio-btn {
    background: none;
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 6px;
    color: var(--gold-light);
    font-size: 0.75rem;
    padding: 4px 8px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .audio-btn:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }
  .top-bar-balance {
    display: flex; align-items: center; gap: 6px;
    background: rgba(201,168,76,0.07);
    border: 1px solid rgba(201,168,76,0.2);
    padding: 5px 12px; white-space: nowrap;
    cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent;
  }
  .top-bar-balance:hover { background: rgba(201,168,76,0.13); border-color: rgba(201,168,76,0.4); }
  .top-bar-balance .tbl-label { font-size: 0.6rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(201,168,76,0.45); }
  .top-bar-balance .tbl-amount { font-family: 'Playfair Display', serif; font-size: 0.95rem; color: var(--gold); }
  @media (max-width: 520px) {
    .top-bar { padding: 8px 12px; }
    .top-bar-title { display: none; }
    .top-bar-balance .tbl-label { display: none; }
    .top-bar-balance { padding: 5px 8px; }
    .audio-btn { font-size: 0.7rem; padding: 3px 6px; }
  }
  @media (max-width: 360px) { .back-link span { display: none; } }

  /* ===== BALANCE MODAL ===== */
  .balance-modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); z-index: 2000;
    align-items: flex-start; justify-content: flex-end;
    padding: 64px 16px 0 0; backdrop-filter: blur(4px);
  }
  .balance-modal-overlay.open { display: flex; }
  .balance-modal {
    background: #0d0d0d; border: 1px solid rgba(201,168,76,0.3);
    width: 340px; max-width: calc(100vw - 24px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    animation: slideDown 0.25s ease; position: relative; overflow: hidden;
  }
  @keyframes slideDown { from { opacity:0; transform:translateY(-16px); } to { opacity:1; transform:translateY(0); } }
  .balance-modal::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); }
  .bm-header { display:flex; align-items:center; justify-content:space-between; padding:18px 20px 14px; border-bottom:1px solid rgba(201,168,76,0.12); }
  .bm-title { font-family:'Playfair Display',serif; color:var(--gold); font-size:1.1rem; letter-spacing:3px; }
  .bm-close { background:none; border:none; color:rgba(201,168,76,0.5); font-size:1.3rem; cursor:pointer; line-height:1; padding:4px; transition:color 0.2s; }
  .bm-close:hover { color:var(--gold); }
  .bm-amount { text-align:center; padding:24px 20px 18px; border-bottom:1px solid rgba(201,168,76,0.1); }
  .bm-amount-label { font-size:0.62rem; letter-spacing:5px; text-transform:uppercase; color:rgba(201,168,76,0.4); margin-bottom:8px; }
  .bm-amount-value { font-family:'Playfair Display',serif; font-size:2.4rem; color:var(--gold); text-shadow:0 0 30px rgba(201,168,76,0.25); }
  .bm-add { padding:16px 20px; border-bottom:1px solid rgba(201,168,76,0.1); text-align:center; }
  .bm-add-hint { font-size:0.62rem; letter-spacing:4px; text-transform:uppercase; color:rgba(201,168,76,0.35); margin-bottom:10px; }
  .btn-add-funds {
    font-family:'Cormorant Garamond',serif; font-size:0.95rem; letter-spacing:3px; text-transform:uppercase;
    padding:11px 32px; background:linear-gradient(135deg,#1a5c30,#27ae60); color:#fff; border:none;
    cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,0.4); transition:all 0.2s; min-height:44px;
  }
  .btn-add-funds:hover { transform:translateY(-1px); box-shadow:0 6px 22px rgba(39,174,96,0.3); }
  .bm-tx-title { font-size:0.62rem; letter-spacing:4px; text-transform:uppercase; color:rgba(201,168,76,0.4); padding:14px 20px 8px; }
  .bm-tx-list { max-height:220px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(201,168,76,0.2) transparent; }
  .bm-tx-list::-webkit-scrollbar { width:4px; }
  .bm-tx-list::-webkit-scrollbar-thumb { background:rgba(201,168,76,0.2); }
  .tx-row { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; border-bottom:1px solid rgba(255,255,255,0.03); font-size:0.88rem; }
  .tx-row:last-child { border-bottom:none; }
  .tx-row:nth-child(even) { background:rgba(255,255,255,0.02); }
  .tx-info-desc { color:rgba(232,224,208,0.65); }
  .tx-info-time { font-size:0.66rem; color:rgba(201,168,76,0.3); margin-top:2px; }
  .tx-amount { font-family:'Playfair Display',serif; font-size:0.95rem; }
  .tx-amount.credit { color:#2ecc71; }
  .tx-amount.debit { color:#e74c3c; }
  .bm-empty { text-align:center; padding:24px; color:rgba(201,168,76,0.3); font-style:italic; font-size:0.95rem; }

  /* ===== HEADER ===== */
  header { text-align:center; padding:clamp(24px,6vw,48px) 20px clamp(16px,4vw,32px); border-bottom:1px solid rgba(201,168,76,0.3); }
  .header-ornament { color:var(--gold); font-size:13px; letter-spacing:8px; text-transform:uppercase; opacity:0.6; margin-bottom:12px; }
  h1 { font-family:'Playfair Display',serif; font-size:clamp(2.2rem,6vw,4.5rem); color:var(--gold); letter-spacing:0.1em; line-height:1; text-shadow:0 0 40px rgba(201,168,76,0.3); }
  h1 span { font-style:italic; font-size:0.58em; display:block; color:var(--gold-light); letter-spacing:clamp(0.15em,2vw,0.35em); margin-top:6px; }
  .gold-line { width:120px; height:1px; background:linear-gradient(90deg,transparent,var(--gold),transparent); margin:18px auto 0; }

  /* ===== NAV TABS ===== */
  nav { display:flex; justify-content:center; gap:0; padding:0 8px; border-bottom:1px solid rgba(201,168,76,0.2); overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
  nav::-webkit-scrollbar { display:none; }
  .tab-btn { background:none; border:none; color:rgba(232,208,138,0.5); font-family:'Cormorant Garamond',serif; font-size:1rem; letter-spacing:4px; text-transform:uppercase; padding:16px 24px; cursor:pointer; position:relative; transition:color 0.3s; white-space:nowrap; -webkit-tap-highlight-color:transparent; }
  .tab-btn::after { content:''; position:absolute; bottom:-1px; left:0; right:0; height:2px; background:var(--gold); transform:scaleX(0); transition:transform 0.3s; }
  .tab-btn.active { color:var(--gold); }
  .tab-btn.active::after { transform:scaleX(1); }
  @media (max-width: 480px) { .tab-btn { font-size:0.85rem; letter-spacing:2px; padding:14px 16px; } }

  /* ===== SECTIONS ===== */
  .section { display:none; max-width:1100px; margin:0 auto; padding:clamp(20px,5vw,40px) clamp(12px,4vw,20px); animation:fadeIn 0.4s ease; }
  .section.active { display:block; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

  /* ===== GAME LAYOUT ===== */
  .game-layout { display:grid; grid-template-columns:1fr minmax(0,780px) 260px; gap:24px; align-items:start; }
  @media (max-width:1060px) { .game-layout { grid-template-columns:1fr; } .side-tables { order:3; } .game-col { order:1; } .side-left { display:none; } }

  /* ===== BET INPUTS ===== */
  .bet-row {
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    padding:20px; background:rgba(0,0,0,0.3); border:1px solid rgba(201,168,76,0.15); margin-bottom:20px;
  }
  .bet-field { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .bet-field label { font-size:0.62rem; letter-spacing:4px; text-transform:uppercase; color:rgba(201,168,76,0.5); }
  .bet-field input {
    font-family:'Playfair Display',serif; font-size:1rem; padding:9px 12px;
    background:rgba(0,0,0,0.4); border:1px solid rgba(201,168,76,0.25); color:var(--gold);
    text-align:center; width:clamp(80px,20vw,110px); outline:none; transition:border-color 0.2s;
  }
  .bet-field input:focus { border-color:var(--gold); }
  .bet-field input::placeholder { color:rgba(201,168,76,0.25); font-family:'Cormorant Garamond',serif; }
  .bet-field input::-webkit-outer-spin-button, .bet-field input::-webkit-inner-spin-button { -webkit-appearance:none; }
  .bet-field input[type=number] { -moz-appearance:textfield; }

  /* ===== STAKE BAR ===== */
  .stake-bar { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; background:rgba(0,0,0,0.3); border:1px solid rgba(201,168,76,0.12); margin-bottom:16px; flex-wrap:wrap; gap:8px; }
  .stake-item { text-align:center; }
  .stake-label { font-size:0.58rem; letter-spacing:3px; text-transform:uppercase; color:rgba(201,168,76,0.45); display:block; }
  .stake-value { font-family:'Playfair Display',serif; font-size:clamp(0.95rem,2.5vw,1.2rem); color:var(--gold); }

  /* ===== FELT TABLE ===== */
  .felt-table {
    background: var(--green-felt); border:3px solid var(--gold-dark);
    box-shadow:0 0 60px rgba(0,0,0,0.8), inset 0 0 60px rgba(0,0,0,0.2);
    padding:clamp(14px,3vw,24px); position:relative; border-radius:4px; margin-bottom:20px;
  }
  .felt-table::before { content:''; position:absolute; inset:6px; border:1px solid rgba(201,168,76,0.15); pointer-events:none; border-radius:2px; }
  .hand-section { margin-bottom:18px; }
  .hand-label { font-family:'Playfair Display',serif; font-size:0.7rem; letter-spacing:5px; text-transform:uppercase; color:rgba(201,168,76,0.6); margin-bottom:10px; text-align:center; }

  /* ===== CARDS ===== */
  .cards-row { display:flex; justify-content:center; gap:clamp(6px,2vw,10px); flex-wrap:wrap; min-height:clamp(76px,16vw,110px); align-items:center; }

  .playing-card {
    width:clamp(52px,11vw,72px); height:clamp(76px,16vw,106px);
    background:var(--card-bg); border-radius:5px; box-shadow:2px 4px 14px rgba(0,0,0,0.6);
    position:relative; display:flex; align-items:center; justify-content:center; flex-direction:column; flex-shrink:0;
    opacity:0; transform:translateY(-40px) scale(0.7) rotate(var(--card-rot, -5deg));
    transition:opacity 0.4s cubic-bezier(0.34,1.56,0.64,1), transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }
  .playing-card.show {
    opacity:1;
    transform:translateY(0) scale(1) rotate(0deg);
  }

  .card-corner-top { position:absolute; top:4px; left:5px; font-size:clamp(0.58rem,1.6vw,0.78rem); line-height:1.15; font-weight:700; }
  .card-corner-bottom { position:absolute; bottom:4px; right:5px; font-size:clamp(0.58rem,1.6vw,0.78rem); line-height:1.15; font-weight:700; transform:rotate(180deg); }
  .card-suit-center { font-size:clamp(1.1rem,3.5vw,1.7rem); }
  .card-red { color:var(--red); }
  .card-black { color:#111; }

  .card-back { background:linear-gradient(135deg,#0d1b2a,#1a2f45,#0d1b2a); border:2px solid rgba(201,168,76,0.25); }
  .card-back::before { content:'‚ú¶'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:clamp(1.2rem,4vw,2rem); color:rgba(201,168,76,0.2); }

  /* 3D flip animation for dealer reveal */
  @keyframes flipIn {
    0%   { transform: perspective(600px) rotateY(90deg) scale(0.8); opacity:0; }
    60%  { transform: perspective(600px) rotateY(-8deg) scale(1.05); opacity:1; }
    100% { transform: perspective(600px) rotateY(0deg) scale(1); opacity:1; }
  }
  .card-flip { animation: flipIn 0.48s cubic-bezier(0.34,1.56,0.64,1) both; }

  @keyframes communityDeal {
    0%   { opacity:0; transform:translateY(-60px) scale(0.5); }
    70%  { transform:translateY(6px) scale(1.06); opacity:1; }
    100% { transform:translateY(0) scale(1); opacity:1; }
  }
  .community-card { animation: communityDeal 0.4s cubic-bezier(0.34,1.56,0.64,1) both; }

  .combo-display { text-align:center; margin-top:8px; min-height:1.8em; font-family:'Playfair Display',serif; font-size:clamp(1rem,3vw,1.35rem); letter-spacing:1px; transition:color 0.3s; }
  .combo-display.better { color:#2ecc71; text-shadow:0 0 16px rgba(46,204,113,0.4); }
  .combo-display.worse  { color:#e74c3c; }
  .combo-display.tie    { color:var(--gold); }
  .combo-display.neutral { color:rgba(201,168,76,0.6); }

  /* ===== RESULT ===== */
  .result-box { text-align:center; padding:14px; background:rgba(0,0,0,0.4); border:1px solid rgba(201,168,76,0.2); min-height:52px; display:flex; align-items:center; justify-content:center; margin-bottom:16px; }
  .result-text { font-family:'Playfair Display',serif; font-size:clamp(1rem,3vw,1.25rem); letter-spacing:1px; }
  .result-win  { color:#2ecc71; text-shadow:0 0 20px rgba(46,204,113,0.4); }
  .result-loss { color:#e74c3c; }
  .result-push { color:var(--gold); }

  /* ===== ACTIONS ===== */
  .action-area { text-align:center; min-height:90px; padding:8px 0; }
  .action-hint { font-size:0.7rem; letter-spacing:4px; text-transform:uppercase; color:rgba(201,168,76,0.45); margin-bottom:14px; }
  .action-btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

  .btn-primary { font-family:'Cormorant Garamond',serif; font-size:clamp(0.85rem,2.5vw,1rem); letter-spacing:clamp(2px,1vw,4px); text-transform:uppercase; padding:clamp(11px,2.5vw,14px) clamp(20px,5vw,36px); background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:var(--darker); border:none; cursor:pointer; font-weight:600; box-shadow:0 4px 20px rgba(201,168,76,0.25); transition:all 0.2s; touch-action:manipulation; -webkit-tap-highlight-color:transparent; min-height:44px; }
  .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(201,168,76,0.35); }
  .btn-primary:disabled { opacity:0.3; cursor:not-allowed; transform:none; }
  .btn-secondary { font-family:'Cormorant Garamond',serif; font-size:clamp(0.85rem,2.5vw,1rem); letter-spacing:clamp(2px,1vw,4px); text-transform:uppercase; padding:clamp(11px,2.5vw,14px) clamp(16px,4vw,28px); background:transparent; color:var(--gold); border:1px solid rgba(201,168,76,0.4); cursor:pointer; transition:all 0.2s; touch-action:manipulation; min-height:44px; }
  .btn-secondary:hover { background:rgba(201,168,76,0.08); border-color:var(--gold); }
  .btn-danger { font-family:'Cormorant Garamond',serif; font-size:clamp(0.85rem,2.5vw,1rem); letter-spacing:clamp(2px,1vw,4px); text-transform:uppercase; padding:clamp(11px,2.5vw,14px) clamp(16px,4vw,28px); background:transparent; color:rgba(231,76,60,0.7); border:1px solid rgba(231,76,60,0.3); cursor:pointer; transition:all 0.2s; min-height:44px; }
  .btn-danger:hover { background:rgba(231,76,60,0.08); border-color:#e74c3c; color:#e74c3c; }

  /* ===== SIDE PAY TABLES ===== */
  .side-tables { display:flex; flex-direction:column; gap:16px; }
  @media (max-width:1060px) { .side-tables { flex-direction:row; flex-wrap:wrap; gap:12px; } .pay-table { flex:1 1 240px; } }
  .pay-table { border:1px solid rgba(201,168,76,0.15); background:linear-gradient(160deg,rgba(201,168,76,0.04),rgba(0,0,0,0.3)); overflow:hidden; }
  .pay-table-head { font-family:'Playfair Display',serif; font-size:0.85rem; letter-spacing:3px; text-transform:uppercase; color:var(--gold); padding:14px 16px 10px; border-bottom:1px solid rgba(201,168,76,0.15); text-align:center; }
  .pay-table table { width:100%; border-collapse:collapse; font-size:clamp(0.78rem,2.2vw,0.88rem); }
  .pay-table td { padding:7px 14px; border-bottom:1px solid rgba(255,255,255,0.04); color:rgba(232,224,208,0.75); }
  .pay-table tr:last-child td { border-bottom:none; }
  .pay-table td:last-child { text-align:right; font-family:'Playfair Display',serif; color:var(--gold-light); }
  .pay-table tr:hover td { background:rgba(201,168,76,0.04); }

  /* ===== STATS TAB ===== */
  .section-title { font-family:'Playfair Display',serif; color:var(--gold); font-size:2rem; text-align:center; letter-spacing:3px; }
  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px; margin-bottom:32px; }
  .stat-card { background:linear-gradient(135deg,rgba(10,61,46,0.3),rgba(0,0,0,0.3)); border:1px solid rgba(201,168,76,0.2); padding:24px 16px; text-align:center; position:relative; }
  .stat-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); }
  .stat-value { font-family:'Playfair Display',serif; font-size:2.2rem; color:var(--gold); display:block; }
  .stat-label { font-size:0.7rem; letter-spacing:4px; text-transform:uppercase; color:rgba(201,168,76,0.5); margin-top:6px; display:block; }

  .win-bar-wrap { margin-bottom:32px; }
  .win-bar-labels { display:flex; justify-content:space-between; font-size:0.75rem; letter-spacing:3px; color:rgba(201,168,76,0.5); text-transform:uppercase; margin-bottom:8px; }
  .win-bar-track { height:8px; background:rgba(255,255,255,0.05); border-radius:4px; overflow:hidden; display:flex; }
  .win-bar-win { background:#2ecc71; transition:width 0.5s; }
  .win-bar-loss { background:#e74c3c; transition:width 0.5s; }

  .history-title { font-family:'Playfair Display',serif; color:var(--gold); font-size:1.3rem; letter-spacing:3px; margin-bottom:16px; text-align:center; }
  .history-table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid rgba(201,168,76,0.1); }
  .history-table { width:100%; min-width:440px; border-collapse:collapse; font-size:0.95rem; }
  .history-table th { color:rgba(201,168,76,0.6); font-size:0.7rem; letter-spacing:3px; text-transform:uppercase; padding:10px 14px; border-bottom:1px solid rgba(201,168,76,0.2); text-align:left; }
  .history-table td { padding:10px 14px; border-bottom:1px solid rgba(255,255,255,0.04); color:rgba(232,224,208,0.8); }
  .history-table tr:hover td { background:rgba(201,168,76,0.04); }
  .pill { display:inline-block; padding:2px 10px; border-radius:2px; font-size:0.8rem; letter-spacing:1px; }
  .pill-win { background:rgba(46,204,113,0.15); color:#2ecc71; }
  .pill-loss { background:rgba(231,76,60,0.15); color:#e74c3c; }
  .pill-push { background:rgba(201,168,76,0.15); color:var(--gold); }
  .empty-history { text-align:center; padding:40px; color:rgba(201,168,76,0.3); font-style:italic; font-size:1.1rem; }
  .reset-btn { display:block; margin:20px auto 0; background:none; border:1px solid rgba(192,57,43,0.3); color:rgba(192,57,43,0.6); font-family:'Cormorant Garamond',serif; letter-spacing:3px; font-size:0.8rem; text-transform:uppercase; padding:8px 24px; cursor:pointer; transition:all 0.2s; }
  .reset-btn:hover { border-color:#c0392b; color:#c0392b; }

  .hand-legend { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-top:8px; }
  .legend-item { display:flex; justify-content:space-between; padding:7px 12px; background:rgba(0,0,0,0.2); border:1px solid rgba(201,168,76,0.08); font-size:0.88rem; }
  .legend-name { color:rgba(232,224,208,0.65); }
  .legend-rank { font-family:'Playfair Display',serif; color:var(--gold-light); font-size:0.82rem; }

  /* ===== FOOTER ===== */
  .games-footer { margin-top:60px; border-top:1px solid rgba(201,168,76,0.15); padding:36px 20px 48px; }
  .games-footer-title { text-align:center; font-size:0.7rem; letter-spacing:6px; text-transform:uppercase; color:rgba(201,168,76,0.4); margin-bottom:24px; }
  .games-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; max-width:700px; margin:0 auto; }
  @media (max-width:500px) { .games-grid { grid-template-columns:1fr; max-width:300px; } }
  .game-card-link { display:block; text-decoration:none; border:1px solid rgba(201,168,76,0.15); padding:20px 12px; text-align:center; transition:all 0.25s; position:relative; overflow:hidden; background:rgba(0,0,0,0.2); -webkit-tap-highlight-color:transparent; }
  .game-card-link::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(201,168,76,0.05),transparent); opacity:0; transition:opacity 0.25s; }
  .game-card-link:hover { border-color:rgba(201,168,76,0.5); transform:translateY(-3px); box-shadow:0 8px 30px rgba(0,0,0,0.4); }
  .game-card-link:hover::before { opacity:1; }
  .game-card-icon { font-size:2rem; display:block; margin-bottom:8px; line-height:1; }
  .game-card-name { font-family:'Playfair Display',serif; font-size:1rem; color:rgba(201,168,76,0.8); letter-spacing:2px; display:block; }
  .game-card-sub { font-size:0.65rem; letter-spacing:3px; text-transform:uppercase; color:rgba(201,168,76,0.35); display:block; margin-top:4px; }

  /* ===== TOAST ===== */
  .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:rgba(10,10,10,0.95); border:1px solid rgba(201,168,76,0.4); color:var(--gold); font-family:'Playfair Display',serif; font-size:0.95rem; letter-spacing:2px; padding:12px 24px; z-index:9999; transition:transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275); max-width:calc(100vw - 40px); text-align:center; }
  .toast.show { transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- Balance Modal -->
<div class="balance-modal-overlay" id="balanceModalOverlay" onclick="closeBMOnBg(event)">
  <div class="balance-modal">
    <div class="bm-header">
      <span class="bm-title">–ë–∞–ª–∞–Ω—Å</span>
      <button class="bm-close" onclick="closeBalanceModal()">‚úï</button>
    </div>
    <div class="bm-amount">
      <div class="bm-amount-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="bm-amount-value" id="bmAmount">‚ÇΩ ‚Äî</div>
    </div>
    <div class="bm-add">
      <div class="bm-add-hint">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <button class="btn-add-funds" onclick="addFunds()">+ 10 000</button>
    </div>
    <div class="bm-tx-title">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
    <div class="bm-tx-list" id="bmTxList"><div class="bm-empty">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div></div>
  </div>
</div>

<!-- Top Bar -->
<div class="top-bar">
  <a href="index.html" class="back-link">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    <span>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
  </a>
  <span class="top-bar-title">Royal Casino</span>
  <div class="top-bar-right">
    <button id="sfx-btn" class="audio-btn" onclick="toggleSfx()">üîä –≠—Ñ—Ñ–µ–∫—Ç—ã</button>
    <button id="music-btn" class="audio-btn" onclick="toggleMusic()">üéµ –ú—É–∑—ã–∫–∞</button>
    <div class="top-bar-balance" onclick="openBalanceModal()">
      <span class="tbl-label">–ë–∞–ª–∞–Ω—Å</span>
      <span class="tbl-amount" id="topBalanceDisplay">‚ÇΩ ‚Äî</span>
    </div>
  </div>
</div>

<header>
  <div class="header-ornament">‚ú¶ &nbsp; Royal Casino &nbsp; ‚ú¶</div>
  <h1>POKER<span>Ultimate Texas Hold'em</span></h1>
  <div class="gold-line"></div>
</header>

<nav>
  <button class="tab-btn active" onclick="showTab('game',this)">–ò–≥—Ä–∞</button>
  <button class="tab-btn" onclick="showTab('stats',this)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button class="tab-btn" onclick="showTab('rules',this)">–ü—Ä–∞–≤–∏–ª–∞</button>
</nav>

<!-- ====== GAME TAB ====== -->
<div id="tab-game" class="section active">
  <div class="game-layout">
    <div class="side-left"></div>
    <div class="game-col">

      <!-- Bet inputs -->
      <div class="bet-row">
        <div class="bet-field">
          <label>BB / Ante</label>
          <input type="number" id="bbBet" min="1" placeholder="100">
        </div>
        <div class="bet-field">
          <label>Trips</label>
          <input type="number" id="tripsBet" min="0" placeholder="0">
        </div>
        <div class="bet-field">
          <label>Ultimate</label>
          <input type="number" id="ultimateBet" min="0" placeholder="0">
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button class="btn-primary" id="startBtn">–†–∞–∑–¥–∞—Ç—å</button>
        </div>
      </div>

      <!-- Stake bar -->
      <div class="stake-bar">
        <div class="stake-item"><span class="stake-label">–ë–∞–ª–∞–Ω—Å</span><span class="stake-value" id="balanceInGame">‚ÇΩ 0</span></div>
        <div class="stake-item"><span class="stake-label">Ante / BB</span><span class="stake-value" id="disp-ante">‚Äî</span></div>
        <div class="stake-item"><span class="stake-label">Play</span><span class="stake-value" id="disp-play">‚Äî</span></div>
        <div class="stake-item"><span class="stake-label">Trips</span><span class="stake-value" id="disp-trips">‚Äî</span></div>
        <div class="stake-item"><span class="stake-label">Ultimate</span><span class="stake-value" id="disp-ult">‚Äî</span></div>
      </div>

      <!-- Felt table -->
      <div class="felt-table">
        <div class="hand-section">
          <div class="hand-label">–î–∏–ª–µ—Ä</div>
          <div class="cards-row" id="botCards"></div>
          <div class="combo-display" id="dealerCombo"></div>
        </div>
        <div style="height:1px;background:rgba(201,168,76,0.15);margin:12px 0;"></div>
        <div class="hand-section">
          <div class="hand-label">–°—Ç–æ–ª</div>
          <div class="cards-row" id="tableCards"></div>
        </div>
        <div style="height:1px;background:rgba(201,168,76,0.15);margin:12px 0;"></div>
        <div class="hand-section" style="margin-bottom:0;">
          <div class="hand-label">–í–∞—à–∏ –∫–∞—Ä—Ç—ã</div>
          <div class="cards-row" id="playerCards"></div>
          <div class="combo-display" id="playerCombo"></div>
        </div>
      </div>

      <div class="result-box" id="resultBox">
        <span class="result-text" style="color:rgba(201,168,76,0.3);font-style:italic;">–°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–∞–∑–¥–∞—Ç—å¬ª</span>
      </div>

      <div class="action-area" id="actionArea">
        <div class="action-btns" id="actionBtns"></div>
      </div>
    </div>

    <!-- Pay tables -->
    <div class="side-tables">
      <div class="pay-table">
        <div class="pay-table-head">Trips Bonus</div>
        <table>
          <tr><td>–°–µ—Ç</td><td>3:1</td></tr>
          <tr><td>–°—Ç—Ä–∏—Ç</td><td>5:1</td></tr>
          <tr><td>–§–ª–µ—à</td><td>7:1</td></tr>
          <tr><td>–§—É–ª–ª-—Ö–∞—É—Å</td><td>10:1</td></tr>
          <tr><td>–ö–∞—Ä–µ</td><td>25:1</td></tr>
          <tr><td>–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à</td><td>40:1</td></tr>
          <tr><td>–†–æ—è–ª-—Ñ–ª–µ—à</td><td>70:1</td></tr>
        </table>
      </div>
      <div class="pay-table">
        <div class="pay-table-head">Ultimate Bonus</div>
        <table>
          <tr><td>AA</td><td>30√ó</td></tr>
          <tr><td>AK suited</td><td>25√ó</td></tr>
          <tr><td>AQ suited</td><td>20√ó</td></tr>
          <tr><td>AJ suited</td><td>15√ó</td></tr>
          <tr><td>KK / QQ / JJ</td><td>15√ó</td></tr>
          <tr><td>AK offsuit</td><td>10√ó</td></tr>
          <tr><td>AQ offsuit</td><td>5√ó</td></tr>
          <tr><td>AJ offsuit</td><td>2√ó</td></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ====== STATS TAB ====== -->
<div id="tab-stats" class="section">
  <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  <div class="gold-line" style="margin-bottom:32px;"></div>

  <div class="stats-grid">
    <div class="stat-card"><span class="stat-value" id="s-games">0</span><span class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</span></div>
    <div class="stat-card"><span class="stat-value" id="s-wins">0</span><span class="stat-label">–ü–æ–±–µ–¥</span></div>
    <div class="stat-card"><span class="stat-value" id="s-losses">0</span><span class="stat-label">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</span></div>
    <div class="stat-card"><span class="stat-value" id="s-folds">0</span><span class="stat-label">–§–æ–ª–¥–æ–≤</span></div>
    <div class="stat-card"><span class="stat-value" id="s-maxwin" style="color:var(--gold);">‚ÇΩ 0</span><span class="stat-label">–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à</span></div>
    <div class="stat-card"><span class="stat-value" id="s-best">‚Äî</span><span class="stat-label">–õ—É—á—à–∞—è –∫–æ–º–±–æ</span></div>
    <div class="stat-card"><span class="stat-value" id="s-totalwon" style="color:#2ecc71;">‚ÇΩ 0</span><span class="stat-label">–í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ</span></div>
    <div class="stat-card"><span class="stat-value" id="s-totallost" style="color:#e74c3c;">‚ÇΩ 0</span><span class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ</span></div>
    <div class="stat-card"><span class="stat-value" id="s-pnl">‚ÇΩ 0</span><span class="stat-label">–ß–∏—Å—Ç—ã–π P&L</span></div>
  </div>

  <div class="win-bar-wrap">
    <div class="win-bar-labels">
      <span id="pct-win">–ü–æ–±–µ–¥—ã 0%</span>
      <span id="pct-loss">–ü–æ—Ä–∞–∂–µ–Ω–∏—è 0%</span>
    </div>
    <div class="win-bar-track">
      <div class="win-bar-win" id="bar-win" style="width:0%"></div>
      <div class="win-bar-loss" id="bar-loss" style="width:0%"></div>
    </div>
  </div>

  <div class="history-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤</div>
  <div id="empty-history" class="empty-history">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥!</div>
  <div class="history-table-wrap" id="history-table-wrap" style="display:none;">
    <table class="history-table">
      <thead><tr><th>#</th><th>–†—É–∫–∞ –∏–≥—Ä–æ–∫–∞</th><th>–†—É–∫–∞ –¥–∏–ª–µ—Ä–∞</th><th>–ò—Å—Ö–æ–¥</th><th>–í—ã–ø–ª–∞—Ç–∞</th></tr></thead>
      <tbody id="history-body"></tbody>
    </table>
  </div>
  <button class="reset-btn" onclick="resetStats()">‚ö† –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>

<!-- ====== RULES TAB ====== -->
<div id="tab-rules" class="section">
  <div class="section-title">–ü—Ä–∞–≤–∏–ª–∞</div>
  <div class="gold-line" style="margin-bottom:32px;"></div>
  <div style="max-width:760px;margin:0 auto;">
    <div style="background:linear-gradient(135deg,rgba(201,168,76,0.05),rgba(10,61,46,0.2));border:1px solid rgba(201,168,76,0.2);padding:28px;margin-bottom:20px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--gold),transparent);"></div>
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.2rem;margin-bottom:16px;letter-spacing:2px;">–û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏</h3>
      <p style="font-size:1rem;line-height:1.8;color:rgba(232,224,208,0.85);font-weight:300;">BB/Ante ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞, —Å—Ç–∞–≤–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã (BB –∏ Ante –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ). <strong style="color:var(--gold)">Trips</strong> ‚Äî –±–æ–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –æ—Ç –°–µ—Ç–∞ –∏ –≤—ã—à–µ. <strong style="color:var(--gold)">Ultimate</strong> ‚Äî –±–æ–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (AA, AK suited –∏ —Ç.–¥.).</p>
    </div>
    <div style="background:linear-gradient(135deg,rgba(201,168,76,0.05),rgba(10,61,46,0.2));border:1px solid rgba(201,168,76,0.2);padding:28px;margin-bottom:20px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--gold),transparent);"></div>
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.2rem;margin-bottom:16px;letter-spacing:2px;">–°—Ç–∞–≤–∫–∞ Play</h3>
      <p style="font-size:1rem;line-height:1.8;color:rgba(232,224,208,0.85);font-weight:300;"><strong style="color:var(--gold)">–ü—Ä–µ—Ñ–ª–æ–ø:</strong> –°—Ç–∞–≤–∫–∞ 4√ó (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å —Å–∏–ª—å–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏) –∏–ª–∏ —á–µ–∫.<br><strong style="color:var(--gold)">–§–ª–æ–ø:</strong> –°—Ç–∞–≤–∫–∞ 2√ó –∏–ª–∏ —á–µ–∫.<br><strong style="color:var(--gold)">–¢–µ—Ä–Ω/–†–∏–≤–µ—Ä:</strong> –°—Ç–∞–≤–∫–∞ 1√ó –∏–ª–∏ —Ñ–æ–ª–¥ (—Ç–µ—Ä—è–µ—Ç–µ Ante –∏ BB).</p>
    </div>
    <div style="background:linear-gradient(135deg,rgba(201,168,76,0.05),rgba(10,61,46,0.2));border:1px solid rgba(201,168,76,0.2);padding:28px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--gold),transparent);"></div>
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.2rem;margin-bottom:16px;letter-spacing:2px;">–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ä—É–∫</h3>
      <div class="hand-legend">
        <div class="legend-item"><span class="legend-name">–†–æ—è–ª-—Ñ–ª–µ—à</span><span class="legend-rank">A K Q J 10 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</span></div>
        <div class="legend-item"><span class="legend-name">–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à</span><span class="legend-rank">5 –ø–æ–¥—Ä—è–¥ –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</span></div>
        <div class="legend-item"><span class="legend-name">–ö–∞—Ä–µ</span><span class="legend-rank">4 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
        <div class="legend-item"><span class="legend-name">–§—É–ª–ª-—Ö–∞—É—Å</span><span class="legend-rank">–¢—Ä–æ–π–∫–∞ + –ø–∞—Ä–∞</span></div>
        <div class="legend-item"><span class="legend-name">–§–ª–µ—à</span><span class="legend-rank">5 –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏</span></div>
        <div class="legend-item"><span class="legend-name">–°—Ç—Ä–∏—Ç</span><span class="legend-rank">5 –∫–∞—Ä—Ç –ø–æ–¥—Ä—è–¥</span></div>
        <div class="legend-item"><span class="legend-name">–°–µ—Ç</span><span class="legend-rank">3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
        <div class="legend-item"><span class="legend-name">–î–≤–µ –ø–∞—Ä—ã</span><span class="legend-rank">2 –ø–∞—Ä—ã</span></div>
        <div class="legend-item"><span class="legend-name">–ü–∞—Ä–∞</span><span class="legend-rank">2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="games-footer">
  <div class="games-footer-title">–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</div>
  <div class="games-grid">
    <a href="baccarat.html" class="game-card-link"><span class="game-card-icon">üé¥</span><span class="game-card-name">Baccarat</span><span class="game-card-sub">Royal Table</span></a>
    <a href="roulette.html" class="game-card-link"><span class="game-card-icon">üé°</span><span class="game-card-name">Roulette</span><span class="game-card-sub">European</span></a>
    <a href="blackjack.html" class="game-card-link"><span class="game-card-icon">üÇ°</span><span class="game-card-name">Blackjack</span><span class="game-card-sub">Classic 21</span></a>
  </div>
</footer>

<div class="toast" id="toast"></div>

<script>
// ==================== CONSTANTS ====================
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
const RED = new Set(['‚ô•','‚ô¶']);
const BAL_KEY = 'casinoBalance';
const TX_KEY = 'pokerTxHistory';
const STATS_KEY = 'pokerStats';

// ==================== STATE ====================
let casinoBalance = parseInt(localStorage.getItem(BAL_KEY) || '10000');
let txHistory = (() => { try { return JSON.parse(localStorage.getItem(TX_KEY)||'[]'); } catch(e){return[];} })();
let pokerStats = (() => { try { return JSON.parse(localStorage.getItem(STATS_KEY)||'{}'); } catch(e){return {};} })();

let deck=[], playerCards=[], botCards=[], flop=[], turn=[], river=[];
let bbBet=0, anteBet=0, tripsBet=0, ultimateBet=0, currentPlayBet=0;
let stage='';
let lastBB=0, lastTrips=0, lastUltimate=0;

// ==================== BALANCE MODAL ====================
function openBalanceModal() {
  renderBalanceModal();
  document.getElementById('balanceModalOverlay').classList.add('open');
}
function closeBalanceModal() { document.getElementById('balanceModalOverlay').classList.remove('open'); }
function closeBMOnBg(e) { if(e.target===document.getElementById('balanceModalOverlay')) closeBalanceModal(); }

function renderBalanceModal() {
  document.getElementById('bmAmount').textContent = fmtMoney(casinoBalance);
  const list = document.getElementById('bmTxList');
  if(!txHistory.length) { list.innerHTML='<div class="bm-empty">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>'; return; }
  list.innerHTML='';
  txHistory.forEach(tx=>{
    const row=document.createElement('div'); row.className='tx-row';
    const credit=tx.amount>0;
    const d=new Date(tx.ts);
    const time=d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    row.innerHTML=`<div><div class="tx-info-desc">${tx.desc}</div><div class="tx-info-time">${time}</div></div><div class="tx-amount ${credit?'credit':'debit'}">${credit?'+':''}${fmtMoney(tx.amount)}</div>`;
    list.appendChild(row);
  });
}

function addFunds() {
  casinoBalance+=10000;
  recordTx('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',10000);
  saveBalance(); updateUI(); renderBalanceModal();
  playChipSound();
  showToast('+ 10 000 –¥–æ–±–∞–≤–ª–µ–Ω–æ');
}

function recordTx(desc,amount) {
  txHistory.unshift({desc,amount,ts:Date.now()});
  if(txHistory.length>150) txHistory=txHistory.slice(0,150);
  localStorage.setItem(TX_KEY,JSON.stringify(txHistory));
}

function saveBalance() { localStorage.setItem(BAL_KEY,casinoBalance); }

function updateUI() {
  document.getElementById('topBalanceDisplay').textContent=fmtMoney(casinoBalance);
  document.getElementById('balanceInGame').textContent=fmtMoney(casinoBalance);
  saveBalance();
}

function fmtMoney(n) { return '‚ÇΩ '+Number(n).toLocaleString('ru-RU'); }

window.addEventListener('focus', ()=>{
  const s=parseInt(localStorage.getItem(BAL_KEY)||casinoBalance);
  if(s!==casinoBalance){casinoBalance=s;updateUI();}
});

// ==================== TABS ====================
function showTab(name,btn) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='stats') renderStats();
}

// ==================== DECK ====================
function createDeck() {
  const d=[];
  for(const s of SUITS) for(const r of RANKS) d.push(r+s);
  return d.sort(()=>Math.random()-0.5);
}
function draw(n) { return deck.splice(0,n); }

// ==================== RENDER CARDS (animated) ====================
function renderCards(containerId, cards, animationType='deal') {
  const el=document.getElementById(containerId);
  el.innerHTML='';
  cards.forEach((card,i)=>{
    const div=document.createElement('div');
    div.className='playing-card';
    if(card==='BACK') {
      div.classList.add('card-back');
    } else {
      const rank=card.slice(0,-1), suit=card.slice(-1);
      const isRed=RED.has(suit);
      div.innerHTML=`
        <div class="card-corner-top ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>
        <div class="card-suit-center ${isRed?'card-red':'card-black'}">${suit}</div>
        <div class="card-corner-bottom ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>`;
    }
    el.appendChild(div);

    const delay = i * 110;
    if(animationType==='community') {
      div.style.animationDelay = delay+'ms';
      div.classList.add('community-card');
      setTimeout(()=>{ div.style.opacity='1'; div.style.transform='none'; }, delay+400);
      // card sound per community card
      setTimeout(()=>playCardSound(), delay);
    } else {
      setTimeout(()=>{
        div.classList.add('show');
        playCardSound();
      }, 80 + delay);
    }
  });
}

// Reveal bot cards with 3D flip animation + sound
function revealBotCards(cards) {
  const el=document.getElementById('botCards');
  el.innerHTML='';
  cards.forEach((card,i)=>{
    const div=document.createElement('div');
    div.className='playing-card';
    const rank=card.slice(0,-1), suit=card.slice(-1);
    const isRed=RED.has(suit);
    div.innerHTML=`
      <div class="card-corner-top ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>
      <div class="card-suit-center ${isRed?'card-red':'card-black'}">${suit}</div>
      <div class="card-corner-bottom ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>`;
    el.appendChild(div);
    const delay=i*200;
    setTimeout(()=>{
      div.classList.add('card-flip');
      div.style.opacity='1';
      playCardSound();
    }, delay);
  });
}

// ==================== HAND EVALUATION ====================
function evaluateHand(cards) {
  const values=cards.map(c=>RANKS.indexOf(c.slice(0,-1))).sort((a,b)=>b-a);
  const suits=cards.map(c=>c.slice(-1));
  const count={};
  values.forEach(v=>count[v]=(count[v]||0)+1);
  const flushSuit=suits.find(s=>suits.filter(x=>x===s).length>=5);
  const flushVals=flushSuit?cards.filter(c=>c.slice(-1)===flushSuit).map(c=>RANKS.indexOf(c.slice(0,-1))).sort((a,b)=>b-a):[];
  const pairs=Object.keys(count).filter(k=>count[k]===2).map(Number).sort((a,b)=>b-a);
  const three=Object.keys(count).filter(k=>count[k]===3).map(Number);
  const four=Object.keys(count).filter(k=>count[k]===4).map(Number);
  function getStraight(vals){
    const u=[...new Set(vals)].sort((a,b)=>b-a);
    for(let i=0;i<=u.length-5;i++) if(u[i]-u[i+4]===4) return u[i];
    if(u.includes(12)&&u.includes(3)&&u.includes(2)&&u.includes(1)&&u.includes(0)) return 3;
    return null;
  }
  const sfHigh=flushSuit?getStraight(flushVals):null;
  const stHigh=getStraight(values);
  if(sfHigh===12) return{score:9,name:'–†–æ—è–ª-—Ñ–ª–µ—à',ranks:flushVals.slice(0,5)};
  if(sfHigh!==null) return{score:8,name:'–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à',ranks:flushVals.slice(0,5)};
  if(four.length) return{score:7,name:'–ö–∞—Ä–µ',ranks:[four[0],...values.filter(v=>v!==four[0]).slice(0,1)]};
  if(three.length&&pairs.length) return{score:6,name:'–§—É–ª–ª-—Ö–∞—É—Å',ranks:[three[0],pairs[0]]};
  if(flushSuit) return{score:5,name:'–§–ª–µ—à',ranks:flushVals.slice(0,5)};
  if(stHigh!==null) return{score:4,name:'–°—Ç—Ä–∏—Ç',ranks:values.slice(0,5)};
  if(three.length) return{score:3,name:'–°–µ—Ç',ranks:[three[0],...values.filter(v=>v!==three[0]).slice(0,2)]};
  if(pairs.length>=2) return{score:2,name:'–î–≤–µ –ø–∞—Ä—ã',ranks:[pairs[0],pairs[1],...values.filter(r=>r!==pairs[0]&&r!==pairs[1]).slice(0,1)]};
  if(pairs.length===1) return{score:1,name:'–ü–∞—Ä–∞',ranks:[pairs[0],...values.filter(r=>r!==pairs[0]).slice(0,3)]};
  return{score:0,name:'–°—Ç–∞—Ä—à–∞—è –∫–∞—Ä—Ç–∞',ranks:values.slice(0,5)};
}

function compareHands(p,d){
  if(p.score!==d.score) return p.score>d.score?1:-1;
  for(let i=0;i<Math.min(p.ranks.length,d.ranks.length);i++) if(p.ranks[i]!==d.ranks[i]) return p.ranks[i]>d.ranks[i]?1:-1;
  return 0;
}

function evaluateUltimate(cards){
  const[c1,c2]=cards; const r1=c1.slice(0,-1),s1=c1.slice(-1),r2=c2.slice(0,-1),s2=c2.slice(-1);
  if(r1==='A'&&r2==='A') return 30;
  if(r1===r2&&['K','Q','J'].includes(r1)) return 15;
  const suited=s1===s2;
  const hasAK=(r1==='A'&&r2==='K')||(r1==='K'&&r2==='A');
  const hasAQ=(r1==='A'&&r2==='Q')||(r1==='Q'&&r2==='A');
  const hasAJ=(r1==='A'&&r2==='J')||(r1==='J'&&r2==='A');
  if(hasAK) return suited?25:10;
  if(hasAQ) return suited?20:5;
  if(hasAJ) return suited?15:2;
  return 0;
}

// ==================== UI HELPERS ====================
function setResult(html,cls){
  document.getElementById('resultBox').innerHTML=`<span class="result-text ${cls}">${html}</span>`;
}

function updateCombo(show){
  const el=document.getElementById('playerCombo');
  if(!show){el.textContent='';el.className='combo-display';return;}
  const all=[...playerCards,...flop,...turn,...river];
  const ev=evaluateHand(all);
  el.textContent=ev.name; el.className='combo-display neutral';
}

function updateStakeBar(){
  document.getElementById('disp-ante').textContent=bbBet>0?fmtMoney(bbBet):'‚Äî';
  document.getElementById('disp-play').textContent=currentPlayBet>0?fmtMoney(currentPlayBet):'‚Äî';
  document.getElementById('disp-trips').textContent=tripsBet>0?fmtMoney(tripsBet):'‚Äî';
  document.getElementById('disp-ult').textContent=ultimateBet>0?fmtMoney(ultimateBet):'‚Äî';
  updateUI();
}

function clearActions(){ document.getElementById('actionBtns').innerHTML=''; }

function lockActions() {
  document.querySelectorAll('#actionBtns button').forEach(b => {
    b.disabled = true;
    b.style.opacity = '0.4';
    b.style.cursor = 'not-allowed';
  });
}

function showActions(hint,buttons){
  const area=document.getElementById('actionBtns');
  area.innerHTML='';
  if(hint){ const h=document.createElement('div'); h.className='action-hint'; h.style.width='100%'; h.textContent=hint; area.appendChild(h); }
  buttons.forEach(({label,cls,onClick})=>{
    const b=document.createElement('button');
    b.className=cls||'btn-secondary';
    b.textContent=label;
    b.onclick=()=>{ lockActions(); onClick(); };
    area.appendChild(b);
  });
}

// Append only new cards to the table without re-animating existing ones
function appendCards(containerId, newCards) {
  const el = document.getElementById(containerId);
  const existingCount = el.children.length;
  newCards.forEach((card, i) => {
    const div = document.createElement('div');
    div.className = 'playing-card';
    const rank = card.slice(0,-1), suit = card.slice(-1);
    const isRed = RED.has(suit);
    div.innerHTML = `
      <div class="card-corner-top ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>
      <div class="card-suit-center ${isRed?'card-red':'card-black'}">${suit}</div>
      <div class="card-corner-bottom ${isRed?'card-red':'card-black'}">${rank}<br>${suit}</div>`;
    el.appendChild(div);
    const delay = i * 180;
    div.style.animationDelay = delay + 'ms';
    div.classList.add('community-card');
    setTimeout(() => { div.style.opacity = '1'; div.style.transform = 'none'; playCardSound(); }, delay);
  });
}

// ==================== GAME FLOW ====================
document.getElementById('startBtn').onclick=startGame;

function startGame(){
  bbBet=parseInt(document.getElementById('bbBet').value)||0;
  anteBet=bbBet;
  tripsBet=parseInt(document.getElementById('tripsBet').value)||0;
  ultimateBet=parseInt(document.getElementById('ultimateBet').value)||0;
  lastBB=bbBet; lastTrips=tripsBet; lastUltimate=ultimateBet;
  if(bbBet<1){showToast('BB / Ante –º–∏–Ω–∏–º—É–º 1');return;}
  const cost=bbBet*2+tripsBet+ultimateBet;
  if(cost>casinoBalance){showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');return;}
  casinoBalance-=cost;
  recordTx('–ü–æ–∫–µ—Ä ‚Äî —Å—Ç–∞–≤–∫–∞ (Ante+BB)',-bbBet*2);
  if(tripsBet>0) recordTx('–ü–æ–∫–µ—Ä ‚Äî Trips',-tripsBet);
  if(ultimateBet>0) recordTx('–ü–æ–∫–µ—Ä ‚Äî Ultimate',-ultimateBet);
  currentPlayBet=0;
  updateStakeBar();
  deck=createDeck();
  playerCards=draw(2); botCards=draw(2);
  flop=[]; turn=[]; river=[];
  renderCards('playerCards',playerCards,'deal');
  renderCards('botCards',['BACK','BACK'],'deal');
  renderCards('tableCards',[],'deal');
  document.getElementById('playerCombo').textContent='';
  document.getElementById('dealerCombo').textContent='';
  setResult(`<div style="text-align:center"><span style="color:rgba(201,168,76,0.35);font-style:italic;">–ü—Ä–µ—Ñ–ª–æ–ø ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</span><div style="font-size:0.82rem;letter-spacing:3px;color:rgba(201,168,76,0.5);margin-top:5px;text-transform:uppercase;">–°—Ç–∞–≤–∫–∞: ${fmtMoney(bbBet*2)}${tripsBet>0?' ¬∑ Trips: '+fmtMoney(tripsBet):''}${ultimateBet>0?' ¬∑ Ultimate: '+fmtMoney(ultimateBet):''}</div></div>`,'');
  stage='preflop';
  setTimeout(()=>{
    showActions('–ü—Ä–µ—Ñ–ª–æ–ø',[
      {label:'–°—Ç–∞–≤–∫–∞ 4√ó',cls:'btn-primary',onClick:()=>playerMove(4)},
      {label:'–ß–µ–∫',cls:'btn-secondary',onClick:()=>playerMove(0)},
    ]);
  }, 400);
}

function playerMove(mult){
  if(mult>0){
    const stake=bbBet*mult;
    if(stake>casinoBalance){showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');return;}
    casinoBalance-=stake;
    recordTx(`–ü–æ–∫–µ—Ä ‚Äî Play bet ${mult}√ó`,-stake);
    currentPlayBet+=stake;
    updateStakeBar();
    playChipSound();
  }
  if(stage==='preflop'){
    if(mult===4){
      draw(1); flop=draw(3); draw(1); turn=draw(1); draw(1); river=draw(1);
      appendCards('tableCards',[...flop,...turn,...river]);
      setTimeout(()=>{updateCombo(true);stage='showdown';finishGame();},flop.length*180+turn.length*180+river.length*180+300);
      return;
    }
    draw(1); flop=draw(3);
    appendCards('tableCards',flop);
    setTimeout(()=>{
      updateCombo(true);
      stage='flop';
      showActions('–§–ª–æ–ø',[
        {label:'–°—Ç–∞–≤–∫–∞ 2√ó',cls:'btn-primary',onClick:()=>playerMove(2)},
        {label:'–ß–µ–∫',cls:'btn-secondary',onClick:()=>playerMove(0)},
      ]);
    }, flop.length*180+300);
  } else if(stage==='flop'){
    if(mult===2){
      draw(1); turn=draw(1); draw(1); river=draw(1);
      appendCards('tableCards',[...turn,...river]);
      setTimeout(()=>{updateCombo(true);stage='showdown';finishGame();},([...turn,...river]).length*180+300);
      return;
    }
    draw(1); turn=draw(1); draw(1); river=draw(1);
    appendCards('tableCards',[...turn,...river]);
    setTimeout(()=>{
      updateCombo(true);
      stage='turn_river';
      showActions('–¢–µ—Ä–Ω / –†–∏–≤–µ—Ä',[
        {label:'–°—Ç–∞–≤–∫–∞ 1√ó',cls:'btn-primary',onClick:()=>playerMove(1)},
        {label:'–§–æ–ª–¥',cls:'btn-danger',onClick:foldGame},
      ]);
    }, ([...turn,...river]).length*180+300);
  } else if(stage==='turn_river'){
    stage='showdown';
    updateCombo(true);
    finishGame();
  }
}

function foldGame(){
  revealBotCards(botCards);
  if(!flop.length){draw(1);flop=draw(3);}
  if(!turn.length){draw(1);turn=draw(1);draw(1);river=draw(1);}
  // Only append cards not yet on table
  const tableEl = document.getElementById('tableCards');
  const existing = tableEl.children.length;
  const allCommunity = [...flop,...turn,...river];
  const toAdd = allCommunity.slice(existing);
  if(toAdd.length) appendCards('tableCards', toAdd);
  setTimeout(()=>{
    const dEv=evaluateHand([...botCards,...flop,...turn,...river]);
    document.getElementById('dealerCombo').textContent=dEv.name;
    document.getElementById('dealerCombo').className='combo-display better';
    updateCombo(true);
    setResult('–í—ã —Å–±—Ä–æ—Å–∏–ª–∏ –∫–∞—Ä—Ç—ã','result-loss');
    const totalBet = bbBet*2 + tripsBet + ultimateBet + currentPlayBet;
    pokerStats.games=(pokerStats.games||0)+1;
    pokerStats.folds=(pokerStats.folds||0)+1;
    pokerStats.losses=(pokerStats.losses||0)+1;
    pokerStats.totalLost=(pokerStats.totalLost||0)+totalBet;
    pokerStats.pnl=(pokerStats.pnl||0)-totalBet;
    savePokerStats();
    clearActions();
    setTimeout(showNewGameBtn,500);
  },600);
}

function finishGame(){
  clearActions();
  setTimeout(()=>{
    revealBotCards(botCards);
    setTimeout(()=>{
      const pAll=[...playerCards,...flop,...turn,...river];
      const dAll=[...botCards,...flop,...turn,...river];
      const pEv=evaluateHand(pAll);
      const dEv=evaluateHand(dAll);
      const cmp=compareHands(pEv,dEv);
      const pEl=document.getElementById('playerCombo');
      const dEl=document.getElementById('dealerCombo');
      pEl.textContent=pEv.name; dEl.textContent=dEv.name;
      if(cmp>0){pEl.className='combo-display better';dEl.className='combo-display worse';}
      else if(cmp<0){pEl.className='combo-display worse';dEl.className='combo-display better';}
      else{pEl.className='combo-display tie';dEl.className='combo-display tie';}
      const playerWins=cmp>0; const tie=cmp===0; const dealerQualified=dEv.score>=1;
      let totalWin=0; const msgs=[];
      if(playerWins){totalWin+=currentPlayBet*2;msgs.push('Play 1:1');}
      else if(tie){totalWin+=currentPlayBet;msgs.push('Play push');}
      if(tie||!dealerQualified){totalWin+=anteBet;msgs.push('Ante push');}
      else if(playerWins){totalWin+=anteBet*2;msgs.push('Ante 1:1');}
      const blindMults={'–°—Ç—Ä–∏—Ç':1,'–§–ª–µ—à':2,'–§—É–ª–ª-—Ö–∞—É—Å':3,'–ö–∞—Ä–µ':10,'–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à':50,'–†–æ—è–ª-—Ñ–ª–µ—à':500};
      if(tie){totalWin+=bbBet;msgs.push('Blind push');}
      else if(playerWins){
        const bm=blindMults[pEv.name]||0;
        if(bm>0){totalWin+=bbBet*(bm+1);msgs.push(`Blind ${bm}:1`);}
        else{totalWin+=bbBet;msgs.push('Blind push');}
      }
      const tripsMults={'–°–µ—Ç':3,'–°—Ç—Ä–∏—Ç':5,'–§–ª–µ—à':7,'–§—É–ª–ª-—Ö–∞—É—Å':10,'–ö–∞—Ä–µ':25,'–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à':40,'–†–æ—è–ª-—Ñ–ª–µ—à':70};
      const tm=tripsMults[pEv.name]||0;
      if(tripsBet>0&&tm>0){totalWin+=tripsBet*(tm+1);msgs.push(`Trips ${tm}:1`);}
      const um=evaluateUltimate(playerCards);
      if(ultimateBet>0&&um>0){totalWin+=ultimateBet*um;msgs.push(`Ultimate ${um}√ó`);}
      casinoBalance+=totalWin;
      if(totalWin>0) recordTx('–ü–æ–∫–µ—Ä ‚Äî –≤—ã–ø–ª–∞—Ç–∞',totalWin);
      updateStakeBar();
      if(playerWins){
        playWinSound();
        setResult(`${totalWin>0?`+${fmtMoney(totalWin)}`:'‚Äî'} &nbsp;¬∑&nbsp; ${msgs.join(' ¬∑ ')}`,'result-win');
      } else if(tie&&totalWin>0){
        setResult(`–ù–∏—á—å—è &nbsp;¬∑&nbsp; ${msgs.join(' ¬∑ ')}`,'result-push');
      } else if(tie){
        setResult(`–ù–∏—á—å—è &nbsp;¬∑&nbsp; ${msgs.join(' ¬∑ ')}`,'result-push');
      } else {
        setResult('–ü—Ä–æ–∏–≥—Ä—ã—à','result-loss');
      }
      // Stats
      const totalBet = bbBet*2 + tripsBet + ultimateBet + currentPlayBet;
      const netPnl = totalWin - totalBet;
      pokerStats.games=(pokerStats.games||0)+1;
      if(playerWins) pokerStats.wins=(pokerStats.wins||0)+1;
      else if(!tie) pokerStats.losses=(pokerStats.losses||0)+1;
      if(totalWin>(pokerStats.maxWin||0)) pokerStats.maxWin=totalWin;
      pokerStats.totalWon=(pokerStats.totalWon||0)+totalWin;
      pokerStats.totalLost=(pokerStats.totalLost||0)+totalBet;
      pokerStats.pnl=(pokerStats.pnl||0)+netPnl;
      const comboRank={'–†–æ—è–ª-—Ñ–ª–µ—à':9,'–°—Ç—Ä–∏—Ç-—Ñ–ª–µ—à':8,'–ö–∞—Ä–µ':7,'–§—É–ª–ª-—Ö–∞—É—Å':6,'–§–ª–µ—à':5,'–°—Ç—Ä–∏—Ç':4,'–°–µ—Ç':3,'–î–≤–µ –ø–∞—Ä—ã':2,'–ü–∞—Ä–∞':1};
      if((comboRank[pEv.name]||0)>(comboRank[pokerStats.bestCombo]||0)) pokerStats.bestCombo=pEv.name;
      if(!pokerStats.rounds) pokerStats.rounds=[];
      pokerStats.rounds.unshift({n:(pokerStats.games||1),pHand:pEv.name,dHand:dEv.name,outcome:playerWins?'win':tie?'push':'loss',payout:totalWin});
      if(pokerStats.rounds.length>80) pokerStats.rounds=pokerStats.rounds.slice(0,80);
      savePokerStats();
      setTimeout(showNewGameBtn,700);
    },500);
  },300);
}

function showNewGameBtn(){
  showActions('',[{
    label:'–ù–æ–≤–∞—è –∏–≥—Ä–∞',cls:'btn-primary',
    onClick:()=>{
      document.getElementById('bbBet').value=lastBB||'';
      document.getElementById('tripsBet').value=lastTrips||'';
      document.getElementById('ultimateBet').value=lastUltimate||'';
      renderCards('playerCards',[],'deal');
      renderCards('botCards',[],'deal');
      renderCards('tableCards',[],'deal');
      document.getElementById('playerCombo').textContent='';
      document.getElementById('dealerCombo').textContent='';
      setResult('<span style="color:rgba(201,168,76,0.3);font-style:italic;">–°–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–∞–∑–¥–∞—Ç—å¬ª</span>','');
      updateStakeBar();
      startGame();
    }
  }]);
}

// ==================== STATS ====================
function savePokerStats() { localStorage.setItem(STATS_KEY, JSON.stringify(pokerStats)); }

function renderStats(){
  document.getElementById('s-games').textContent=pokerStats.games||0;
  document.getElementById('s-wins').textContent=pokerStats.wins||0;
  document.getElementById('s-losses').textContent=pokerStats.losses||0;
  document.getElementById('s-folds').textContent=pokerStats.folds||0;
  document.getElementById('s-maxwin').textContent=fmtMoney(pokerStats.maxWin||0);
  document.getElementById('s-best').textContent=pokerStats.bestCombo||'‚Äî';

  const won = pokerStats.totalWon||0;
  const lost = pokerStats.totalLost||0;
  const pnl = pokerStats.pnl||0;
  document.getElementById('s-totalwon').textContent = fmtMoney(won);
  document.getElementById('s-totallost').textContent = fmtMoney(lost);
  const pnlEl = document.getElementById('s-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+' : '') + fmtMoney(pnl);
  pnlEl.style.color = pnl > 0 ? '#2ecc71' : pnl < 0 ? '#e74c3c' : 'var(--gold)';

  const total=(pokerStats.games||0);
  const wins=pokerStats.wins||0;
  const losses=pokerStats.losses||0;
  const wPct=total>0?Math.round(wins/total*100):0;
  const lPct=total>0?Math.round(losses/total*100):0;
  document.getElementById('bar-win').style.width=wPct+'%';
  document.getElementById('bar-loss').style.width=lPct+'%';
  document.getElementById('pct-win').textContent=`–ü–æ–±–µ–¥—ã ${wPct}%`;
  document.getElementById('pct-loss').textContent=`–ü–æ—Ä–∞–∂–µ–Ω–∏—è ${lPct}%`;

  const rounds=pokerStats.rounds||[];
  const empty=document.getElementById('empty-history');
  const wrap=document.getElementById('history-table-wrap');
  if(!rounds.length){empty.style.display='block';wrap.style.display='none';return;}
  empty.style.display='none'; wrap.style.display='block';
  const tbody=document.getElementById('history-body');
  tbody.innerHTML='';
  rounds.forEach(r=>{
    const pillMap={win:'pill-win',push:'pill-push',loss:'pill-loss'};
    const labelMap={win:'–ü–æ–±–µ–¥–∞',push:'–ù–∏—á—å—è',loss:'–ü—Ä–æ–∏–≥—Ä—ã—à'};
    const pnlColor=r.payout>0?'#2ecc71':r.outcome==='push'?'var(--gold)':'#e74c3c';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="opacity:0.5">#${r.n}</td><td>${r.pHand}</td><td>${r.dHand}</td><td><span class="pill ${pillMap[r.outcome]}">${labelMap[r.outcome]}</span></td><td style="color:${pnlColor}">${r.payout>0?'+':''}${fmtMoney(r.payout)}</td>`;
    tbody.appendChild(tr);
  });
}

function resetStats(){
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫–µ—Ä–∞?')) return;
  pokerStats={};
  savePokerStats();
  renderStats();
  showToast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
}

// ==================== TOAST ====================
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ==================== AUDIO ENGINE ====================
let audioCtx = null;
let musicGain = null;
let musicNodes = [];
let musicLoopTimer = null;
let sfxEnabled = true;
let musicEnabled = false;

function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// ‚îÄ‚îÄ SFX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function playCardSound() {
  if (!sfxEnabled) return;
  try {
    const ctx = getAudioCtx();
    const t = ctx.currentTime;
    const bufSize = Math.floor(ctx.sampleRate * 0.13);
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random()*2-1) * Math.pow(1-i/bufSize, 1.5);
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filt = ctx.createBiquadFilter(); filt.type='bandpass'; filt.frequency.value=2400; filt.Q.value=0.6;
    const g = ctx.createGain(); g.gain.setValueAtTime(0.22,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.13);
    src.connect(filt); filt.connect(g); g.connect(ctx.destination);
    src.start(t); src.stop(t+0.14);
    // tap click
    const o = ctx.createOscillator(); o.frequency.value=1100;
    const tg = ctx.createGain(); tg.gain.setValueAtTime(0.09,t+0.07); tg.gain.exponentialRampToValueAtTime(0.001,t+0.13);
    o.connect(tg); tg.connect(ctx.destination); o.start(t+0.07); o.stop(t+0.14);
  } catch(e) {}
}

function playChipSound() {
  if (!sfxEnabled) return;
  try {
    const ctx = getAudioCtx();
    const t = ctx.currentTime;
    // Stack of two coin-like pings
    [0, 0.04].forEach((dt, i) => {
      const o = ctx.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(1400-i*200, t+dt);
      o.frequency.exponentialRampToValueAtTime(700-i*100, t+dt+0.08);
      const g = ctx.createGain(); g.gain.setValueAtTime(0.13,t+dt); g.gain.exponentialRampToValueAtTime(0.001,t+dt+0.1);
      o.connect(g); g.connect(ctx.destination); o.start(t+dt); o.stop(t+dt+0.11);
    });
  } catch(e) {}
}

function playWinSound() {
  if (!sfxEnabled) return;
  try {
    const ctx = getAudioCtx();
    // Bright ascending fanfare: C E G C
    const melody = [523,659,784,1047,1319];
    melody.forEach((freq,i) => {
      const t = ctx.currentTime + i*0.09;
      const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value=freq;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.14,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.28);
      o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.3);
    });
  } catch(e) {}
}

// ‚îÄ‚îÄ MUSIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startMusic() {
  if (!musicEnabled) return;
  stopMusic();
  try {
    const ctx = getAudioCtx();

    const masterGain = ctx.createGain();
    masterGain.gain.value = 0.08;
    masterGain.connect(ctx.destination);
    musicGain = masterGain;

    // === Las Vegas swing feel: 126 BPM, Bb major ===
    const BPM = 126;
    const B = 60 / BPM;           // one beat = ~0.476s
    const bar = B * 4;             // one bar  = ~1.905s

    // Chord voicings (swing jazz in Bb major)
    // Bb6/9  ‚Üí  Gm7  ‚Üí  Cm7  ‚Üí  F9  (classic I‚Äìvi‚Äìii‚ÄìV turnaround)
    const chordVoicings = [
      [116.5, 155.6, 174.6, 233.1, 311.1],  // Bb6/9
      [98.0,  146.8, 196.0, 220.0, 293.7],   // Gm7
      [130.8, 155.6, 196.0, 261.6, 329.6],   // Cm7
      [87.3,  138.6, 174.6, 207.7, 277.2],   // F9
    ];

    // Walking bass lines (one note per beat, root-based)
    const bassLines = [
      [58.3, 65.4, 69.3, 77.8],   // Bb walk
      [49.0, 55.0, 61.7, 65.4],   // Gm walk
      [65.4, 73.4, 77.8, 87.3],   // Cm walk
      [43.7, 49.0, 55.0, 58.3],   // F walk
    ];

    // Swing rhythm for chords: beats 2 & 4 (comping)
    const compBeats = [1, 3];     // 0-indexed beats in the bar

    function noteOn(freq, startT, dur, vol, type='sine') {
      try {
        const o = ctx.createOscillator(); o.type = type; o.frequency.value = freq;
        const g = ctx.createGain();
        g.gain.setValueAtTime(0, startT);
        g.gain.linearRampToValueAtTime(vol, startT + 0.015);
        g.gain.setValueAtTime(vol, startT + dur * 0.75);
        g.gain.linearRampToValueAtTime(0, startT + dur);
        o.connect(g); g.connect(masterGain);
        o.start(startT); o.stop(startT + dur + 0.02);
        musicNodes.push(o);
      } catch(e) {}
    }

    function scheduleHiHat(startT, numBars) {
      try {
        const steps = numBars * 8; // 8th notes
        for (let i = 0; i < steps; i++) {
          const t0 = startT + i * (B / 2);
          // Swing: every odd 8th note slightly delayed
          const swingT = i % 2 === 1 ? t0 + B * 0.05 : t0;
          const bufSz = Math.floor(ctx.sampleRate * 0.025);
          const hbuf = ctx.createBuffer(1, bufSz, ctx.sampleRate);
          const d = hbuf.getChannelData(0);
          for (let j = 0; j < bufSz; j++) d[j] = (Math.random()*2-1) * Math.pow(1-j/bufSz,2.5);
          const src = ctx.createBufferSource(); src.buffer = hbuf;
          const hpf = ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=9000;
          const hg = ctx.createGain();
          // Accent on beats 1 & 3, lighter elsewhere
          const onBeat = i%4===0 || i%4===2;
          hg.gain.value = onBeat ? 0.055 : 0.025;
          src.connect(hpf); hpf.connect(hg); hg.connect(masterGain);
          src.start(swingT);
          musicNodes.push(src);
        }
      } catch(e) {}
    }

    function scheduleKick(startT, numBars) {
      // Kick on beat 1 of each bar
      for (let b = 0; b < numBars; b++) {
        const t0 = startT + b * bar;
        const o = ctx.createOscillator(); o.type = 'sine';
        o.frequency.setValueAtTime(90, t0);
        o.frequency.exponentialRampToValueAtTime(35, t0 + 0.09);
        const g = ctx.createGain();
        g.gain.setValueAtTime(0.45, t0);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.12);
        o.connect(g); g.connect(masterGain);
        o.start(t0); o.stop(t0 + 0.15);
        musicNodes.push(o);
      }
    }

    function scheduleSnare(startT, numBars) {
      // Snare on beats 2 & 4
      for (let b = 0; b < numBars; b++) {
        [1, 3].forEach(beat => {
          const t0 = startT + b * bar + beat * B;
          const bufSz = Math.floor(ctx.sampleRate * 0.09);
          const sbuf = ctx.createBuffer(1, bufSz, ctx.sampleRate);
          const sd = sbuf.getChannelData(0);
          for (let j = 0; j < bufSz; j++) sd[j] = (Math.random()*2-1) * Math.pow(1-j/bufSz,1.2);
          const ssrc = ctx.createBufferSource(); ssrc.buffer = sbuf;
          const bpf = ctx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=2200; bpf.Q.value=0.5;
          const sg = ctx.createGain(); sg.gain.value = 0.18;
          ssrc.connect(bpf); bpf.connect(sg); sg.connect(masterGain);
          ssrc.start(t0);
          musicNodes.push(ssrc);
          // Snare tone
          const so = ctx.createOscillator(); so.type='sine'; so.frequency.value=185;
          const stg = ctx.createGain(); stg.gain.setValueAtTime(0.08,t0); stg.gain.exponentialRampToValueAtTime(0.001,t0+0.05);
          so.connect(stg); stg.connect(masterGain); so.start(t0); so.stop(t0+0.06);
          musicNodes.push(so);
        });
      }
    }

    function scheduleBar(barIndex, startT, chord, bass) {
      // Comp chords on beats 2 & 4 (swing)
      compBeats.forEach(beat => {
        const t0 = startT + beat * B;
        chord.forEach(freq => noteOn(freq, t0, B * 0.55, 0.022 / chord.length, 'sine'));
      });
      // Walking bass: one note per beat, triangle wave
      bass.forEach((freq, i) => {
        const t0 = startT + i * B;
        noteOn(freq, t0, B * 0.82, 0.28, 'triangle');
      });
      // Simple melody hint (lead note from chord on beat 1 and 3)
      [0, 2].forEach((beat, j) => {
        const t0 = startT + beat * B + (beat===2 ? B*0.05 : 0); // swing feel on beat 3
        const melFreq = chord[chord.length-1] * (j===0 ? 2 : 1.5); // top chord note
        noteOn(melFreq, t0, B * 0.4, 0.018, 'sine');
      });
    }

    const LOOP_BARS = chordVoicings.length; // 4 bars

    function scheduleLoop(startT) {
      if (!musicEnabled) return;
      const loopDur = LOOP_BARS * bar;

      for (let i = 0; i < LOOP_BARS; i++) {
        scheduleBar(i, startT + i * bar, chordVoicings[i], bassLines[i]);
      }
      scheduleHiHat(startT, LOOP_BARS);
      scheduleKick(startT, LOOP_BARS);
      scheduleSnare(startT, LOOP_BARS);

      // Schedule next loop slightly before this one ends
      musicLoopTimer = setTimeout(() => {
        if (musicEnabled) scheduleLoop(ctx.currentTime + 0.15);
      }, (loopDur - 0.5) * 1000);
    }

    scheduleLoop(ctx.currentTime + 0.05);
  } catch(e) { console.warn('Music error:', e); }
}

function stopMusic() {
  if (musicLoopTimer) { clearTimeout(musicLoopTimer); musicLoopTimer = null; }
  musicNodes.forEach(n => { try { n.stop(); } catch(e) {} });
  musicNodes = [];
  if (musicGain) { try { musicGain.disconnect(); } catch(e){} musicGain = null; }
}

function toggleSfx() {
  sfxEnabled = !sfxEnabled;
  const btn = document.getElementById('sfx-btn');
  btn.textContent = sfxEnabled ? 'üîä –≠—Ñ—Ñ–µ–∫—Ç—ã' : 'üîá –≠—Ñ—Ñ–µ–∫—Ç—ã';
  btn.style.opacity = sfxEnabled ? '1' : '0.5';
  if (sfxEnabled) playChipSound();
}

function toggleMusic() {
  musicEnabled = !musicEnabled;
  const btn = document.getElementById('music-btn');
  btn.textContent = musicEnabled ? 'üéµ –ú—É–∑—ã–∫–∞' : 'üîï –ú—É–∑—ã–∫–∞';
  btn.style.opacity = musicEnabled ? '1' : '0.5';
  if (musicEnabled) startMusic();
  else stopMusic();
}

// ==================== INIT ====================
updateUI();
</script>
</body>
</html>
